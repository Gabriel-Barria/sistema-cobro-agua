{% extends "base.html" %}

{% block title %}Gestion de Usuarios{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Gestion de Usuarios</h1>
    <a href="{{ url_for('usuarios.crear') }}" class="btn btn--primary">+ Nuevo Usuario</a>
</div>

{% if usuarios %}
<table class="data-table data-table--striped data-table--hover">
    <thead>
        <tr>
            <th>Usuario</th>
            <th>Nombre Completo</th>
            <th>Rol</th>
            <th>Estado</th>
            <th>Creado</th>
            <th>Acciones</th>
        </tr>
    </thead>
    <tbody>
        {% for usuario in usuarios %}
        <tr>
            <td>{{ usuario.username }}</td>
            <td>{{ usuario.nombre_completo }}</td>
            <td>
                <span class="badge {% if usuario.rol == 'administrador' %}badge--info{% else %}badge--secondary{% endif %}">
                    {{ usuario.rol|capitalize }}
                </span>
            </td>
            <td>
                <span class="badge {% if usuario.activo %}badge--success{% else %}badge--secondary{% endif %}">
                    {{ 'Activo' if usuario.activo else 'Inactivo' }}
                </span>
            </td>
            <td>{{ usuario.created_at|fecha_formato }}</td>
            <td>
                <div class="action-btn-group">
                    <a href="{{ url_for('usuarios.editar', usuario_id=usuario.id) }}" class="action-btn" title="Editar">
                        <i class="fas fa-edit"></i>
                    </a>
                    <a href="{{ url_for('usuarios.cambiar_pass', usuario_id=usuario.id) }}" class="action-btn" title="Cambiar password">
                        <i class="fas fa-key"></i>
                    </a>
                    {% if usuario.activo %}
                    <button class="action-btn action-btn--danger" title="Desactivar" onclick="desactivarUsuario({{ usuario.id }}, '{{ usuario.username }}')">
                        <i class="fas fa-user-slash"></i>
                    </button>
                    {% endif %}
                </div>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% else %}
<div class="empty-state">
    <div class="empty-state__icon"><i class="fas fa-users-cog"></i></div>
    <h3 class="empty-state__title">No hay usuarios</h3>
    <p class="empty-state__description">No se han creado usuarios aun.</p>
    <a href="{{ url_for('usuarios.crear') }}" class="btn btn--primary">+ Nuevo Usuario</a>
</div>
{% endif %}

<script>
function desactivarUsuario(usuarioId, username) {
    ConfirmModal.show({
        title: 'Desactivar Usuario',
        message: 'Se desactivara el usuario <strong>' + username + '</strong>. No podra iniciar sesion.',
        icon: 'warning',
        confirmText: 'Desactivar',
        confirmClass: 'btn--danger'
    }).then(function(ok) {
        if (ok) {
            var form = document.createElement('form');
            form.method = 'POST';
            form.action = '/usuarios/' + usuarioId + '/eliminar';
            document.body.appendChild(form);
            form.submit();
        }
    });
}
</script>
{% endblock %}
