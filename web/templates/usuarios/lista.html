{% extends "base.html" %}

{% block title %}Gestion de Usuarios{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Gestion de Usuarios</h1>
    <div>
        <a href="{{ url_for('usuarios.crear') }}" class="btn btn--primary hide-mobile"><i class="fas fa-plus"></i> Nuevo Usuario</a>
        <a href="{{ url_for('usuarios.crear') }}" class="btn btn--primary hide-desktop"><i class="fas fa-plus"></i> Nuevo</a>
    </div>
</div>

<!-- Stats Section -->
<div class="stats-toggle--enhanced hide-mobile" onclick="toggleStats()">
    <span><i class="fas fa-chart-bar"></i> Estadisticas</span>
    <i class="fas fa-chevron-down" id="statsChevron"></i>
</div>
<div class="stats-collapsible hide-mobile" id="statsSection">
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-card__value">{{ stats.total }}</div>
            <div class="stat-card__label">Total</div>
        </div>
        <div class="stat-card stat-card--success">
            <div class="stat-card__value">{{ stats.activos }}</div>
            <div class="stat-card__label">Activos</div>
        </div>
        <div class="stat-card stat-card--secondary">
            <div class="stat-card__value">{{ stats.inactivos }}</div>
            <div class="stat-card__label">Inactivos</div>
        </div>
    </div>
</div>

{% if usuarios %}
<!-- Desktop Table -->
<table class="data-table data-table--striped data-table--hover hide-mobile">
    <thead>
        <tr>
            <th>Usuario</th>
            <th>Nombre Completo</th>
            <th>Rol</th>
            <th>Estado</th>
            <th>Creado</th>
            <th>Acciones</th>
        </tr>
    </thead>
    <tbody>
        {% for usuario in usuarios %}
        <tr{% if not usuario.activo %} class="row--inactive"{% endif %}>
            <td>{{ usuario.username }}</td>
            <td>{{ usuario.nombre_completo }}</td>
            <td>
                <span class="badge {% if usuario.rol == 'administrador' %}badge--info{% else %}badge--secondary{% endif %}">
                    {{ usuario.rol|capitalize }}
                </span>
            </td>
            <td>
                <span class="badge {% if usuario.activo %}badge--success{% else %}badge--secondary{% endif %}">
                    {{ 'Activo' if usuario.activo else 'Inactivo' }}
                </span>
            </td>
            <td>{{ usuario.created_at|fecha_formato }}</td>
            <td>
                <div class="action-btn-group">
                    <a href="{{ url_for('usuarios.editar', usuario_id=usuario.id) }}" class="action-btn" title="Editar">
                        <i class="fas fa-edit"></i>
                    </a>
                    <a href="{{ url_for('usuarios.cambiar_pass', usuario_id=usuario.id) }}" class="action-btn" title="Cambiar password">
                        <i class="fas fa-key"></i>
                    </a>
                    {% if usuario.activo %}
                    <button class="action-btn action-btn--danger" title="Desactivar" onclick="desactivarUsuario({{ usuario.id }}, '{{ usuario.username }}')">
                        <i class="fas fa-user-slash"></i>
                    </button>
                    {% endif %}
                </div>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<!-- Mobile Card View -->
<div class="hide-desktop">
    {% for usuario in usuarios %}
    <div class="usuario-card {% if usuario.activo %}usuario-card--active{% else %}usuario-card--inactive{% endif %}" data-expanded="false" onclick="toggleCard(this)">
        <div class="usuario-card__summary">
            <div class="usuario-card__left">
                <div class="usuario-card__username">{{ usuario.username }}</div>
                <div class="usuario-card__name">{{ usuario.nombre_completo }}</div>
            </div>
            <div class="usuario-card__right">
                <span class="badge {% if usuario.rol == 'administrador' %}badge--info{% else %}badge--secondary{% endif %}">
                    {{ usuario.rol|capitalize }}
                </span>
                <div class="usuario-card__chevron"><i class="fas fa-chevron-down"></i></div>
            </div>
        </div>
        <div class="usuario-card__details">
            <div class="usuario-card__details-inner">
                <div class="usuario-card__info">
                    <div class="usuario-card__info-item">
                        Estado
                        <span>
                            <span class="badge {% if usuario.activo %}badge--success{% else %}badge--secondary{% endif %}">
                                {{ 'Activo' if usuario.activo else 'Inactivo' }}
                            </span>
                        </span>
                    </div>
                    <div class="usuario-card__info-item">
                        Creado
                        <span>{{ usuario.created_at|fecha_formato }}</span>
                    </div>
                </div>
                <div class="usuario-card__actions-primary">
                    <a href="{{ url_for('usuarios.editar', usuario_id=usuario.id) }}" class="btn btn--secondary btn--sm" onclick="event.stopPropagation()">
                        <i class="fas fa-edit"></i> Editar
                    </a>
                    <a href="{{ url_for('usuarios.cambiar_pass', usuario_id=usuario.id) }}" class="btn btn--secondary btn--sm" onclick="event.stopPropagation()">
                        <i class="fas fa-key"></i> Cambiar Password
                    </a>
                    {% if usuario.activo %}
                    <button class="btn btn--danger btn--sm" onclick="event.stopPropagation(); desactivarUsuario({{ usuario.id }}, '{{ usuario.username }}')">
                        <i class="fas fa-user-slash"></i> Desactivar
                    </button>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% else %}
<!-- Empty States -->
<div class="empty-state hide-mobile">
    <div class="empty-state__icon"><i class="fas fa-users-cog"></i></div>
    <h3 class="empty-state__title">No hay usuarios</h3>
    <p class="empty-state__description">No se han creado usuarios aun.</p>
    <a href="{{ url_for('usuarios.crear') }}" class="btn btn--primary">Nuevo Usuario</a>
</div>
<div class="empty-state hide-desktop">
    <div class="empty-state__icon"><i class="fas fa-users"></i></div>
    <h3 class="empty-state__title">Sin usuarios</h3>
    <p class="empty-state__description">No hay usuarios registrados.</p>
    <a href="{{ url_for('usuarios.crear') }}" class="btn btn--primary">Nuevo Usuario</a>
</div>
{% endif %}

<script>
function toggleCard(card) {
    var expanded = card.getAttribute('data-expanded') === 'true';
    card.setAttribute('data-expanded', !expanded);
}

function toggleStats() {
    var section = document.getElementById('statsSection');
    var chevron = document.getElementById('statsChevron');
    var isOpen = section.style.display !== 'none';
    section.style.display = isOpen ? 'none' : 'block';
    chevron.style.transform = isOpen ? '' : 'rotate(180deg)';
    localStorage.setItem('usuarios-stats-open', !isOpen);
}

(function() {
    var saved = localStorage.getItem('usuarios-stats-open');
    if (saved === 'false') {
        var section = document.getElementById('statsSection');
        var chevron = document.getElementById('statsChevron');
        if (section) { section.style.display = 'none'; }
        if (chevron) { chevron.style.transform = ''; }
    }
})();

function desactivarUsuario(usuarioId, username) {
    ConfirmModal.show({
        title: 'Desactivar Usuario',
        message: 'Se desactivara el usuario <strong>' + username + '</strong>. No podra iniciar sesion.',
        icon: 'warning',
        confirmText: 'Desactivar',
        confirmClass: 'btn--danger'
    }).then(function(ok) {
        if (ok) {
            var form = document.createElement('form');
            form.method = 'POST';
            form.action = '/usuarios/' + usuarioId + '/eliminar';
            document.body.appendChild(form);
            form.submit();
        }
    });
}
</script>
{% endblock %}
