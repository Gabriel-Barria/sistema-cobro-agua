{% extends "base.html" %}

{% block title %}Pago {{ pago.numero_pago }} - Sistema de Lecturas{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Pago {{ pago.numero_pago }}</h1>
    <a href="{{ url_for('boletas.pagos_lista') }}" class="btn btn--secondary">Volver a Pagos</a>
</div>

<div class="detail-grid">
    <div class="detail-section">
        <h3>Informacion del Pago</h3>
        <table class="detail-table">
            <tr>
                <th>Numero:</th>
                <td>{{ pago.numero_pago }}</td>
            </tr>
            <tr>
                <th>Cliente:</th>
                <td>{{ pago.cliente_nombre }}</td>
            </tr>
            <tr>
                <th>Metodo:</th>
                <td>{{ pago.metodo_pago|capitalize if pago.metodo_pago else '-' }}</td>
            </tr>
            <tr>
                <th>Fecha Pago:</th>
                <td>{{ pago.fecha_pago or '-' }}</td>
            </tr>
            <tr>
                <th>Fecha Envio:</th>
                <td>{{ pago.fecha_envio }}</td>
            </tr>
            {% if pago.notas %}
            <tr>
                <th>Notas:</th>
                <td>{{ pago.notas }}</td>
            </tr>
            {% endif %}
        </table>
    </div>

    <div class="detail-section detail-section--{{ 'success' if pago.estado == 'aprobado' else 'danger' if pago.estado == 'rechazado' else 'warning' if pago.estado == 'en_revision' else '' }}">
        <h3>Estado y Montos</h3>
        <table class="detail-table">
            <tr>
                <th>Estado:</th>
                <td>
                    {% if pago.estado == 'aprobado' %}
                        <span class="badge badge--success">APROBADO</span>
                    {% elif pago.estado == 'rechazado' %}
                        <span class="badge badge--danger">RECHAZADO</span>
                    {% elif pago.estado == 'en_revision' %}
                        <span class="badge badge--warning">EN REVISION</span>
                    {% else %}
                        <span class="badge badge--secondary">{{ pago.estado|upper }}</span>
                    {% endif %}
                </td>
            </tr>
            <tr>
                <th>Monto Total:</th>
                <td style="font-size: 1.3em; font-weight: bold;">${{ pago.monto_total|formato_pesos }}</td>
            </tr>
            <tr>
                <th>Monto Aplicado:</th>
                <td>${{ pago.monto_aplicado|formato_pesos }}</td>
            </tr>
            {% if pago.monto_a_favor > 0 %}
            <tr>
                <th>Saldo a Favor:</th>
                <td class="text-success" style="font-weight: bold;">${{ pago.monto_a_favor|formato_pesos }}</td>
            </tr>
            {% endif %}
            {% if pago.fecha_procesamiento %}
            <tr>
                <th>Fecha Proceso:</th>
                <td>{{ pago.fecha_procesamiento }}</td>
            </tr>
            {% endif %}
            {% if pago.procesado_por_nombre %}
            <tr>
                <th>Procesado por:</th>
                <td>{{ pago.procesado_por_nombre }}</td>
            </tr>
            {% endif %}
            {% if pago.motivo_rechazo %}
            <tr>
                <th>Motivo Rechazo:</th>
                <td class="text-danger">{{ pago.motivo_rechazo }}</td>
            </tr>
            {% endif %}
        </table>

        {% if pago.comprobante_path %}
        <div style="margin-top: var(--spacing-md);">
            <a href="/{{ pago.comprobante_path }}" target="_blank" class="btn btn--primary"><i class="fas fa-paperclip"></i> Ver Comprobante</a>
        </div>
        {% endif %}

        {% if pago.estado == 'en_revision' %}
        <div style="margin-top: var(--spacing-lg); display: flex; gap: var(--spacing-sm);">
            <button type="button" class="btn btn--success" onclick="aprobarPago()"><i class="fas fa-check"></i> Aprobar Pago</button>
            <button type="button" class="btn btn--danger" onclick="rechazarPago()"><i class="fas fa-times"></i> Rechazar Pago</button>
        </div>
        {% endif %}
    </div>
</div>

<h3 style="margin-top: var(--spacing-xl);">Boletas Asociadas ({{ pago.boletas|length }})</h3>
{% if pago.boletas %}
<table class="data-table data-table--striped data-table--hover">
    <thead>
        <tr>
            <th>Boleta</th>
            <th>Total Boleta</th>
            <th>Monto Aplicado</th>
            <th>Pago Completo</th>
            <th>Saldo Pendiente</th>
            <th>Estado</th>
            <th>Acciones</th>
        </tr>
    </thead>
    <tbody>
        {% for b in pago.boletas %}
        <tr>
            <td>{{ b.numero_boleta }}</td>
            <td>${{ b.boleta_total|formato_pesos }}</td>
            <td>${{ b.monto_aplicado|formato_pesos }}</td>
            <td>
                {% if b.es_pago_completo %}
                <span class="text-success">Si</span>
                {% else %}
                <span class="text-warning">Parcial</span>
                {% endif %}
            </td>
            <td>${{ b.saldo_pendiente|formato_pesos }}</td>
            <td>
                {% if b.pagada == 2 %}
                <span class="badge badge--success">Pagada</span>
                {% elif b.pagada == 1 %}
                <span class="badge badge--warning">En Revision</span>
                {% else %}
                <span class="badge badge--danger">Pendiente</span>
                {% endif %}
            </td>
            <td>
                <a href="{{ url_for('boletas.detalle', boleta_id=b.boleta_id) }}" class="action-btn" title="Ver boleta">
                    <i class="fas fa-eye"></i>
                </a>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% else %}
<div class="empty-state">
    <div class="empty-state__icon"><i class="fas fa-file-invoice"></i></div>
    <h3 class="empty-state__title">Sin boletas</h3>
    <p class="empty-state__description">Este pago no tiene boletas asociadas.</p>
</div>
{% endif %}

<script>
function aprobarPago() {
    ConfirmModal.show({
        title: 'Aprobar Pago',
        message: 'Se aprobara este pago y se aplicara a las boletas correspondientes.',
        icon: 'success',
        confirmText: 'Aprobar',
        confirmClass: 'btn--success'
    }).then(function(ok) {
        if (ok) {
            var form = document.createElement('form');
            form.method = 'POST';
            form.action = '{{ url_for("boletas.aprobar_pago_route", pago_id=pago.id) }}';
            document.body.appendChild(form);
            form.submit();
        }
    });
}

function rechazarPago() {
    ConfirmModal.show({
        title: 'Rechazar Pago',
        message: 'El pago sera rechazado y las boletas volveran a estado pendiente.',
        icon: 'danger',
        confirmText: 'Rechazar',
        confirmClass: 'btn--danger',
        showInput: true,
        inputLabel: 'Motivo del rechazo:',
        inputPlaceholder: 'Ingrese el motivo...',
        inputRequired: true
    }).then(function(motivo) {
        if (motivo) {
            var form = document.createElement('form');
            form.method = 'POST';
            form.action = '{{ url_for("boletas.rechazar_pago_route", pago_id=pago.id) }}';
            var input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'motivo';
            input.value = motivo;
            form.appendChild(input);
            document.body.appendChild(form);
            form.submit();
        }
    });
}
</script>
{% endblock %}
