{% extends "base.html" %}

{% block title %}Crear Boletas Masivo - Sistema de Lecturas{% endblock %}

{% block content %}
<!-- HEADER -->
<div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6">
    <h1 class="text-2xl font-bold">Crear Boletas - Modo Masivo</h1>
    <a href="{{ url_for('boletas.listar') }}" class="btn btn-ghost">
        <i class="fas fa-arrow-left"></i>
        <span class="hidden sm:inline">Cancelar</span>
    </a>
</div>

<!-- CONFIG INFO -->
<div class="alert alert-info mb-4">
    <i class="fas fa-info-circle"></i>
    <span>
        <strong>Tarifas actuales:</strong>
        Cargo fijo: ${{ config.cargo_fijo|formato_pesos }} |
        Precio por m3: ${{ config.precio_m3|formato_pesos }}
    </span>
    <a href="{{ url_for('boletas.configuracion') }}" class="btn btn-ghost btn-sm">Cambiar</a>
</div>

<!-- FILTERS -->
<div class="card bg-base-100 shadow mb-4">
    <div class="card-body py-4">
        <form method="GET" class="flex flex-wrap gap-4 items-end">
            <div class="form-control">
                <label class="label">
                    <span class="label-text">Filtrar por cliente</span>
                </label>
                <select name="cliente_id" id="cliente_id" class="select select-bordered select-sm">
                    <option value="">Todos</option>
                    {% for cliente in clientes %}
                    <option value="{{ cliente.id }}" {{ 'selected' if filtros.cliente_id == cliente.id }}>
                        {{ cliente.nombre }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-control">
                <label class="label">
                    <span class="label-text">Ano</span>
                </label>
                <select name="anio" id="anio" class="select select-bordered select-sm">
                    <option value="">Todos</option>
                    {% for a in anios %}
                    <option value="{{ a }}" {{ 'selected' if filtros.anio == a }}>{{ a }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-control">
                <label class="label">
                    <span class="label-text">Mes</span>
                </label>
                <select name="mes" id="mes" class="select select-bordered select-sm">
                    <option value="">Todos</option>
                    {% for m in range(1, 13) %}
                    <option value="{{ m }}" {{ 'selected' if filtros.mes == m }}>{{ m }}</option>
                    {% endfor %}
                </select>
            </div>

            <button type="submit" class="btn btn-primary btn-sm">
                <i class="fas fa-filter"></i> Filtrar
            </button>
        </form>
    </div>
</div>

{% if lecturas %}
<form method="POST" id="form-masivo">
    <div class="flex flex-wrap gap-2 mb-4 items-center">
        <button type="button" id="btn-seleccionar-todo" class="btn btn-ghost btn-sm">Seleccionar Todo</button>
        <button type="button" id="btn-deseleccionar-todo" class="btn btn-ghost btn-sm">Deseleccionar Todo</button>
        <span id="contador-seleccionados" class="badge badge-neutral">0 lecturas seleccionadas</span>
    </div>

    <div class="overflow-x-auto">
        <table class="table table-zebra bg-base-100">
            <thead>
                <tr>
                    <th><input type="checkbox" id="check-all" class="checkbox checkbox-sm"></th>
                    <th>Cliente</th>
                    <th>Medidor</th>
                    <th>Periodo</th>
                    <th>Lectura (m3)</th>
                </tr>
            </thead>
            <tbody>
                {% for lectura in lecturas %}
                <tr class="hover">
                    <td>
                        <input type="checkbox" name="lecturas" value="{{ lectura.id }}" class="checkbox checkbox-sm check-lectura">
                    </td>
                    <td>{{ lectura.cliente_nombre }}</td>
                    <td>{{ lectura.numero_medidor or 'Medidor ' ~ lectura.medidor_id }}</td>
                    <td>{{ lectura.mes }}/{{ lectura.anio }}</td>
                    <td>{{ lectura.lectura_m3 }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="card-actions justify-center mt-6">
        <button type="submit" class="btn btn-primary btn-lg">
            <i class="fas fa-file-invoice"></i> Crear Boletas Seleccionadas
        </button>
    </div>
</form>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const checkAll = document.getElementById('check-all');
    const checks = document.querySelectorAll('.check-lectura');
    const contador = document.getElementById('contador-seleccionados');
    const btnSelectAll = document.getElementById('btn-seleccionar-todo');
    const btnDeselectAll = document.getElementById('btn-deseleccionar-todo');

    function actualizarContador() {
        const seleccionados = document.querySelectorAll('.check-lectura:checked').length;
        contador.textContent = seleccionados + ' lecturas seleccionadas';
    }

    checkAll.addEventListener('change', function() {
        checks.forEach(check => check.checked = this.checked);
        actualizarContador();
    });

    checks.forEach(check => {
        check.addEventListener('change', actualizarContador);
    });

    btnSelectAll.addEventListener('click', function() {
        checks.forEach(check => check.checked = true);
        checkAll.checked = true;
        actualizarContador();
    });

    btnDeselectAll.addEventListener('click', function() {
        checks.forEach(check => check.checked = false);
        checkAll.checked = false;
        actualizarContador();
    });

    document.getElementById('form-masivo').addEventListener('submit', function(e) {
        const seleccionados = document.querySelectorAll('.check-lectura:checked').length;
        if (seleccionados === 0) {
            e.preventDefault();
            Toast.warning('Debe seleccionar al menos una lectura');
            return false;
        }
        e.preventDefault();
        var form = this;
        ConfirmModal.show({
            title: 'Crear Boletas',
            message: 'Se crearan ' + seleccionados + ' boletas. Continuar?',
            icon: 'warning',
            confirmText: 'Crear Boletas',
            confirmClass: 'btn-primary'
        }).then(function(ok) {
            if (ok) form.submit();
        });
    });
});
</script>
{% else %}
<div class="card bg-base-100 shadow">
    <div class="card-body items-center text-center py-12">
        <i class="fas fa-file-invoice text-5xl text-base-content/30 mb-4"></i>
        <h3 class="card-title">Sin lecturas disponibles</h3>
        <p class="text-base-content/70 mb-4">
            No hay lecturas disponibles sin boleta para los filtros seleccionados.
        </p>
        <ul class="text-left text-base-content/70 text-sm">
            <li>- Todas las lecturas ya tienen boleta asociada</li>
            <li>- No hay lecturas registradas</li>
            <li>- Los filtros no coinciden con ninguna lectura</li>
        </ul>
    </div>
</div>
{% endif %}
{% endblock %}
