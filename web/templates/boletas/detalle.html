{% extends "base.html" %}

{% block title %}Boleta {{ boleta.numero_boleta }} - Sistema de Lecturas{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Boleta {{ boleta.numero_boleta }}</h1>
    <div>
        <a href="{{ url_for('boletas.descargar', boleta_id=boleta.id) }}" class="btn btn--primary"><i class="fas fa-download"></i> Descargar</a>
        <a href="{{ url_for('boletas.listar') }}" class="btn btn--secondary">Volver</a>
    </div>
</div>

<div class="detail-grid">
    <div class="detail-section">
        <h3>Datos del Cliente</h3>
        <table class="detail-table">
            <tr>
                <th>Cliente:</th>
                <td>{{ boleta.cliente_nombre }}</td>
            </tr>
            <tr>
                <th>Medidor ID:</th>
                <td>{{ boleta.medidor_id }}</td>
            </tr>
            <tr>
                <th>Periodo:</th>
                <td>{{ boleta.periodo_mes|mes_nombre }} {{ boleta.periodo_a√±o }}</td>
            </tr>
            <tr>
                <th>Fecha Emision:</th>
                <td>{{ boleta.fecha_emision }}</td>
            </tr>
        </table>
    </div>

    <div class="detail-section detail-section--{{ 'success' if boleta.pagada == 2 else 'warning' if boleta.pagada == 1 else 'danger' }}">
        <h3>Estado de Pago</h3>
        {% if boleta.pagada == 2 %}
            <span class="badge badge--success" style="font-size: 14px;">PAGADA</span>
            <p style="margin-top: var(--spacing-sm);">
                <strong>Fecha de pago:</strong> {{ boleta.fecha_pago }}<br>
                <strong>Metodo:</strong> {{ boleta.metodo_pago|capitalize if boleta.metodo_pago else '-' }}
            </p>
            {% if boleta.comprobante_path %}
                <p><a href="/{{ boleta.comprobante_path }}" target="_blank" class="btn btn--primary btn--sm"><i class="fas fa-paperclip"></i> Ver comprobante</a></p>
            {% else %}
                <p class="form-help" style="margin-top: var(--spacing-sm);"><i class="fas fa-exclamation-triangle"></i> Sin comprobante adjunto</p>
            {% endif %}
        {% elif boleta.pagada == 1 %}
            <span class="badge badge--warning" style="font-size: 14px;">EN REVISION</span>
            <p style="margin-top: var(--spacing-sm);">Comprobante enviado, pendiente de aprobacion.</p>
            {% if boleta.comprobante_path %}
                <p><a href="/{{ boleta.comprobante_path }}" target="_blank" class="btn btn--primary btn--sm"><i class="fas fa-paperclip"></i> Ver comprobante</a></p>
            {% endif %}
        {% else %}
            <span class="badge badge--danger" style="font-size: 14px;">PENDIENTE</span>
        {% endif %}
    </div>
</div>

<div class="detail-section" style="margin-top: var(--spacing-lg);">
    <h3>Detalle de Consumo</h3>
    <table class="data-table data-table--striped">
        <thead>
            <tr>
                <th>Concepto</th>
                <th>Cantidad</th>
                <th>Precio Unitario</th>
                <th>Subtotal</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>Cargo Fijo</td>
                <td>1</td>
                <td>${{ boleta.cargo_fijo|formato_pesos }}</td>
                <td>${{ boleta.cargo_fijo|formato_pesos }}</td>
            </tr>
            <tr>
                <td>
                    Consumo de agua
                    <small class="form-help">
                        Lectura actual: {{ boleta.lectura_actual }} m3
                        {% if boleta.lectura_anterior %}
                        | Anterior: {{ boleta.lectura_anterior }} m3
                        {% endif %}
                    </small>
                </td>
                <td>{{ boleta.consumo_m3 }} m3</td>
                <td>${{ boleta.precio_m3|formato_pesos }}</td>
                <td>${{ boleta.subtotal_consumo|formato_pesos }}</td>
            </tr>
        </tbody>
        <tfoot>
            <tr style="font-weight: bold; font-size: 1.2em;">
                <td colspan="3" style="text-align: right;">TOTAL:</td>
                <td>${{ boleta.total|formato_pesos }}</td>
            </tr>
        </tfoot>
    </table>
</div>

{% if pagos %}
<div class="detail-section" style="margin-top: var(--spacing-lg);">
    <h3>Pagos Asociados</h3>
    <table class="data-table data-table--striped data-table--hover">
        <thead>
            <tr>
                <th>N Pago</th>
                <th>Fecha Envio</th>
                <th>Monto Aplicado</th>
                <th>Estado</th>
                <th>Fecha Proceso</th>
                <th>Detalle</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody>
            {% for pago in pagos %}
            <tr>
                <td>{{ pago.numero_pago }}</td>
                <td>{{ pago.fecha_envio }}</td>
                <td>${{ pago.monto_aplicado|formato_pesos }}</td>
                <td>
                    {% if pago.estado == 'aprobado' %}
                        <span class="badge badge--success">Aprobado</span>
                    {% elif pago.estado == 'rechazado' %}
                        <span class="badge badge--danger">Rechazado</span>
                    {% elif pago.estado == 'en_revision' %}
                        <span class="badge badge--warning">En Revision</span>
                    {% else %}
                        <span class="badge badge--secondary">{{ pago.estado }}</span>
                    {% endif %}
                </td>
                <td>{{ pago.fecha_procesamiento or '-' }}</td>
                <td>
                    {% if pago.estado == 'rechazado' %}
                        {{ pago.motivo_rechazo }}
                    {% elif pago.estado == 'aprobado' %}
                        {{ pago.metodo_pago|capitalize if pago.metodo_pago else '-' }}
                    {% else %}
                        -
                    {% endif %}
                </td>
                <td>
                    <div class="action-btn-group">
                        <a href="{{ url_for('boletas.pago_detalle', pago_id=pago.id) }}" class="action-btn" title="Ver pago">
                            <i class="fas fa-eye"></i>
                        </a>
                        {% if pago.comprobante_path %}
                        <a href="/{{ pago.comprobante_path }}" target="_blank" class="action-btn" title="Ver comprobante">
                            <i class="fas fa-paperclip"></i>
                        </a>
                        {% endif %}
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}

<div class="actions-section">
    <h3>Acciones</h3>

    {% if not boleta.pagada %}
    <div style="margin-bottom: var(--spacing-lg);">
        <h4>Marcar como pagada</h4>
        <form method="POST" action="{{ url_for('boletas.marcar_pagada', boleta_id=boleta.id) }}" style="display: flex; gap: var(--spacing-sm); align-items: end;">
            <div class="form-group" style="margin: 0;">
                <label for="metodo_pago">Metodo de pago:</label>
                <select name="metodo_pago" id="metodo_pago" required>
                    <option value="efectivo">Efectivo</option>
                    <option value="transferencia">Transferencia</option>
                </select>
            </div>
            <button type="submit" class="btn btn--success">Marcar Pagada</button>
        </form>
    </div>
    {% else %}
    <div style="margin-bottom: var(--spacing-lg);">
        <button type="button" class="btn btn--warning" onclick="desmarcarPagada()">Desmarcar Pagada</button>
    </div>
    {% endif %}

    {% if boleta.pagada %}
    <div style="margin-bottom: var(--spacing-lg);">
        <h4>Subir Comprobante</h4>
        <form method="POST" action="{{ url_for('boletas.subir_comprobante', boleta_id=boleta.id) }}"
              enctype="multipart/form-data" style="display: flex; gap: var(--spacing-sm); align-items: end;">
            <div class="form-group" style="margin: 0;">
                <label for="comprobante">Archivo (imagen o PDF):</label>
                <input type="file" name="comprobante" id="comprobante" accept=".jpg,.jpeg,.png,.gif,.pdf" required>
            </div>
            <button type="submit" class="btn btn--primary"><i class="fas fa-upload"></i> Subir</button>
        </form>
    </div>
    {% endif %}

    <div style="border-top: 1px solid var(--color-border); padding-top: var(--spacing-lg); margin-top: var(--spacing-lg);">
        <button type="button" class="btn btn--danger" onclick="eliminarBoleta()"><i class="fas fa-trash"></i> Eliminar Boleta</button>
    </div>
</div>

<script>
function desmarcarPagada() {
    ConfirmModal.show({
        title: 'Desmarcar Pagada',
        message: 'Se desmarcara esta boleta como pagada y volvera a estado pendiente.',
        icon: 'warning',
        confirmText: 'Desmarcar',
        confirmClass: 'btn--warning'
    }).then(function(ok) {
        if (ok) {
            var form = document.createElement('form');
            form.method = 'POST';
            form.action = '{{ url_for("boletas.desmarcar_pagada", boleta_id=boleta.id) }}';
            document.body.appendChild(form);
            form.submit();
        }
    });
}

function eliminarBoleta() {
    ConfirmModal.show({
        title: 'Eliminar Boleta',
        message: 'Esta accion no se puede deshacer. Se eliminara permanentemente la boleta.',
        icon: 'danger',
        confirmText: 'Eliminar',
        confirmClass: 'btn--danger'
    }).then(function(ok) {
        if (ok) {
            var form = document.createElement('form');
            form.method = 'POST';
            form.action = '{{ url_for("boletas.eliminar", boleta_id=boleta.id) }}';
            document.body.appendChild(form);
            form.submit();
        }
    });
}
</script>
{% endblock %}
