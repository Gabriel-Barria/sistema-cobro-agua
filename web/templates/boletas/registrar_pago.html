{% extends "base.html" %}

{% block title %}Registrar Pago - Sistema de Lecturas{% endblock %}

{% block content %}
<!-- HEADER -->
<div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6">
    <h1 class="text-2xl font-bold">Registrar Pago</h1>
    <a href="{{ url_for('boletas.pagos_lista') }}" class="btn btn-ghost">
        <i class="fas fa-arrow-left"></i>
        <span class="hidden sm:inline">Cancelar</span>
    </a>
</div>

<div class="card bg-base-100 shadow max-w-3xl mx-auto">
    <div class="card-body">
        <form method="POST" id="formPago" enctype="multipart/form-data">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div class="form-control">
                    <label class="label">
                        <span class="label-text font-medium">Cliente *</span>
                    </label>
                    <select name="cliente_id" id="cliente_id" required onchange="cargarBoletas()" class="select select-bordered">
                        <option value="">Seleccionar cliente...</option>
                        {% for c in clientes %}
                        <option value="{{ c.id }}" {{ 'selected' if cliente_id == c.id }}>{{ c.nombre }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-control">
                    <label class="label">
                        <span class="label-text font-medium">Monto del Pago *</span>
                    </label>
                    <input type="number" name="monto" id="monto" required step="1" min="1" placeholder="Ej: 25000"
                           class="input input-bordered">
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div class="form-control">
                    <label class="label">
                        <span class="label-text font-medium">Metodo de Pago</span>
                    </label>
                    <select name="metodo_pago" id="metodo_pago" onchange="toggleComprobante()" class="select select-bordered">
                        <option value="efectivo">Efectivo</option>
                        <option value="transferencia">Transferencia</option>
                        <option value="deposito">Deposito</option>
                        <option value="cheque">Cheque</option>
                    </select>
                </div>

                <div class="form-control">
                    <label class="label">
                        <span class="label-text font-medium">Fecha del Pago</span>
                    </label>
                    <input type="date" name="fecha_pago" id="fecha_pago" value="{{ today }}"
                           class="input input-bordered">
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div class="form-control">
                    <label class="label">
                        <span class="label-text font-medium">Notas (opcional)</span>
                    </label>
                    <textarea name="notas" id="notas" rows="2" placeholder="Observaciones adicionales..."
                              class="textarea textarea-bordered"></textarea>
                </div>

                <div class="form-control">
                    <label class="label">
                        <span class="label-text font-medium">Comprobante <span id="comprobanteReq">*</span></span>
                    </label>
                    <input type="file" name="comprobante" id="comprobante" accept=".jpg,.jpeg,.png,.gif,.pdf"
                           class="file-input file-input-bordered">
                    <label class="label">
                        <span class="label-text-alt text-base-content/70" id="comprobanteHelp">Requerido para transferencia</span>
                    </label>
                </div>
            </div>

            <div class="card bg-base-200 mb-4" id="boletasSection" style="display: {% if boletas_pendientes %}block{% else %}none{% endif %};">
                <div class="card-body">
                    <h3 class="card-title text-base">Boletas Pendientes</h3>
                    <p class="text-sm text-base-content/70 mb-4">Selecciona las boletas a las que aplicar este pago:</p>

                    <div class="max-h-64 overflow-y-auto border border-base-300 rounded-lg bg-base-100" id="boletasList">
                        {% if boletas_pendientes %}
                        {% for b in boletas_pendientes %}
                        <label class="flex items-center p-3 border-b border-base-200 cursor-pointer hover:bg-base-200">
                            <input type="checkbox" name="boletas" value="{{ b.id }}" onchange="actualizarTotal()" class="checkbox checkbox-sm mr-3">
                            <div class="flex-1 flex justify-between items-center">
                                <span class="font-medium">{{ b.numero_boleta }}</span>
                                <span class="text-base-content/70">{{ b.periodo_mes }}/{{ b.periodo_anio }}</span>
                                <span class="font-bold">${{ b.total|formato_pesos }}</span>
                            </div>
                        </label>
                        {% endfor %}
                        {% endif %}
                    </div>

                    <div class="mt-4 p-4 bg-base-100 rounded-lg border border-base-300">
                        <div class="flex justify-between py-1">
                            <span>Total seleccionado:</span>
                            <span id="totalSeleccionado">$0</span>
                        </div>
                        <div class="flex justify-between py-1">
                            <span>Monto del pago:</span>
                            <span id="montoPago">$0</span>
                        </div>
                        <div class="flex justify-between py-2 border-t border-base-300 mt-2 font-bold" id="diferenciaRow">
                            <span>Diferencia:</span>
                            <span id="diferencia">$0</span>
                        </div>
                    </div>

                    <div class="flex gap-2 mt-4">
                        <button type="button" class="btn btn-ghost btn-sm" onclick="seleccionarTodas()">Seleccionar todas</button>
                        <button type="button" class="btn btn-ghost btn-sm" onclick="deseleccionarTodas()">Deseleccionar todas</button>
                    </div>
                </div>
            </div>

            <div class="card-actions justify-center">
                <button type="submit" class="btn btn-primary btn-lg" id="btnSubmit" disabled>
                    <i class="fas fa-check"></i> Registrar Pago
                </button>
            </div>
        </form>
    </div>
</div>

<script>
let boletasData = {};

{% if boletas_pendientes %}
{% for b in boletas_pendientes %}
boletasData[{{ b.id }}] = {{ b.total }};
{% endfor %}
{% endif %}

function cargarBoletas() {
    const clienteId = document.getElementById('cliente_id').value;
    if (!clienteId) {
        document.getElementById('boletasSection').style.display = 'none';
        return;
    }

    // Cargar boletas via AJAX
    fetch(`/boletas/api/boletas-pendientes/${clienteId}`)
        .then(response => response.json())
        .then(boletas => {
            const lista = document.getElementById('boletasList');
            lista.innerHTML = '';
            boletasData = {};

            if (boletas.length === 0) {
                lista.innerHTML = '<p class="p-4 text-center text-base-content/70">Este cliente no tiene boletas pendientes.</p>';
                document.getElementById('boletasSection').style.display = 'block';
                actualizarTotal();
                return;
            }

            boletas.forEach(b => {
                boletasData[b.id] = b.saldo_pendiente;
                const label = document.createElement('label');
                label.className = 'flex items-center p-3 border-b border-base-200 cursor-pointer hover:bg-base-200';
                label.innerHTML = `
                    <input type="checkbox" name="boletas" value="${b.id}" onchange="actualizarTotal()" class="checkbox checkbox-sm mr-3">
                    <div class="flex-1 flex justify-between items-center">
                        <span class="font-medium">${b.numero_boleta}</span>
                        <span class="text-base-content/70">${b.periodo}</span>
                        <span class="font-bold">$${b.saldo_pendiente.toLocaleString('es-CL')}</span>
                    </div>
                `;
                lista.appendChild(label);
            });

            document.getElementById('boletasSection').style.display = 'block';
            actualizarTotal();
        })
        .catch(error => {
            console.error('Error cargando boletas:', error);
        });
}

function actualizarTotal() {
    const checkboxes = document.querySelectorAll('input[name="boletas"]:checked');
    let total = 0;

    checkboxes.forEach(cb => {
        total += boletasData[cb.value] || 0;
    });

    const monto = parseFloat(document.getElementById('monto').value) || 0;
    const diferencia = monto - total;

    document.getElementById('totalSeleccionado').textContent = '$' + total.toLocaleString('es-CL');
    document.getElementById('montoPago').textContent = '$' + monto.toLocaleString('es-CL');
    document.getElementById('diferencia').textContent = '$' + diferencia.toLocaleString('es-CL');

    const diferenciaEl = document.getElementById('diferencia');
    if (diferencia > 0) {
        diferenciaEl.className = 'text-success';
        diferenciaEl.textContent = '+$' + diferencia.toLocaleString('es-CL') + ' (saldo a favor)';
    } else if (diferencia < 0) {
        diferenciaEl.className = 'text-error';
        diferenciaEl.textContent = '-$' + Math.abs(diferencia).toLocaleString('es-CL') + ' (faltante)';
    } else {
        diferenciaEl.className = '';
    }

    // Habilitar/deshabilitar boton submit
    const btnSubmit = document.getElementById('btnSubmit');
    btnSubmit.disabled = !(checkboxes.length > 0 && monto > 0);
}

function seleccionarTodas() {
    document.querySelectorAll('input[name="boletas"]').forEach(cb => cb.checked = true);
    actualizarTotal();
}

function deseleccionarTodas() {
    document.querySelectorAll('input[name="boletas"]').forEach(cb => cb.checked = false);
    actualizarTotal();
}

// Actualizar total cuando cambia el monto
document.getElementById('monto').addEventListener('input', actualizarTotal);

function toggleComprobante() {
    const metodo = document.getElementById('metodo_pago').value;
    const input = document.getElementById('comprobante');
    const reqLabel = document.getElementById('comprobanteReq');
    const help = document.getElementById('comprobanteHelp');

    if (metodo === 'transferencia') {
        input.required = true;
        reqLabel.style.display = 'inline';
        help.textContent = 'Requerido para transferencia';
    } else {
        input.required = false;
        reqLabel.style.display = 'none';
        help.textContent = 'Opcional';
    }
}

// Inicializar estado del comprobante
toggleComprobante();

// Inicializar
{% if cliente_id %}
actualizarTotal();
{% endif %}
</script>
{% endblock %}
