{% extends "base.html" %}

{% block title %}Pagos - Sistema de Lecturas{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Historial de Pagos</h1>
    <div>
        <a href="{{ url_for('boletas.registrar_pago_admin') }}" class="btn btn--primary">Registrar Pago</a>
        <a href="{{ url_for('boletas.saldos_lista') }}" class="btn btn--secondary">Ver Saldos</a>
        <a href="{{ url_for('boletas.listar') }}" class="btn btn--secondary">Volver a Boletas</a>
    </div>
</div>

<form method="GET" class="filter-bar" id="filterFormPagos">
    <div class="filter-bar__fields">
        <div class="filter-bar__group">
            <label for="estado">Estado</label>
            <select name="estado" id="estado">
                <option value="">Todos</option>
                <option value="pendiente" {{ 'selected' if filtros.estado == 'pendiente' }}>Pendientes</option>
                <option value="en_revision" {{ 'selected' if filtros.estado == 'en_revision' }}>En Revision</option>
                <option value="aprobado" {{ 'selected' if filtros.estado == 'aprobado' }}>Aprobados</option>
                <option value="rechazado" {{ 'selected' if filtros.estado == 'rechazado' }}>Rechazados</option>
            </select>
        </div>
        <div class="filter-bar__group">
            <label for="cliente_id">Cliente</label>
            <select name="cliente_id" id="cliente_id">
                <option value="">Todos los clientes</option>
                {% for c in clientes %}
                <option value="{{ c.id }}" {{ 'selected' if filtros.cliente_id == c.id }}>{{ c.nombre }}</option>
                {% endfor %}
            </select>
        </div>
    </div>
    <div class="filter-bar__actions">
        <button type="submit" class="btn btn--primary">Filtrar</button>
        {% if filtros.estado or filtros.cliente_id %}
        <a href="{{ url_for('boletas.pagos_lista') }}" class="btn btn--secondary">Limpiar</a>
        {% endif %}
    </div>
</form>

<p class="total-results">Mostrando {{ pagos|length }} pago(s)</p>

{% if pagos %}
<table class="data-table data-table--striped data-table--hover">
    <thead>
        <tr>
            <th>N Pago</th>
            <th>Cliente</th>
            <th>Monto</th>
            <th>Aplicado</th>
            <th>Saldo Favor</th>
            <th>Metodo</th>
            <th>Fecha Envio</th>
            <th>Estado</th>
            <th>Boletas</th>
            <th>Acciones</th>
        </tr>
    </thead>
    <tbody>
        {% for p in pagos %}
        <tr>
            <td>
                <a href="{{ url_for('boletas.pago_detalle', pago_id=p.id) }}">{{ p.numero_pago }}</a>
            </td>
            <td>{{ p.cliente_nombre }}</td>
            <td>${{ p.monto_total|formato_pesos }}</td>
            <td>${{ p.monto_aplicado|formato_pesos }}</td>
            <td>
                {% if p.monto_a_favor > 0 %}
                <span class="text-success">${{ p.monto_a_favor|formato_pesos }}</span>
                {% else %}-{% endif %}
            </td>
            <td>{{ p.metodo_pago|capitalize if p.metodo_pago else '-' }}</td>
            <td>{{ p.fecha_envio }}</td>
            <td>
                {% if p.estado == 'aprobado' %}
                    <span class="badge badge--success">Aprobado</span>
                {% elif p.estado == 'rechazado' %}
                    <span class="badge badge--danger">Rechazado</span>
                {% elif p.estado == 'en_revision' %}
                    <span class="badge badge--warning">En Revision</span>
                {% else %}
                    <span class="badge badge--secondary">{{ p.estado|capitalize }}</span>
                {% endif %}
            </td>
            <td>{{ p.num_boletas }}</td>
            <td>
                <div class="action-btn-group">
                    <a href="{{ url_for('boletas.pago_detalle', pago_id=p.id) }}" class="action-btn" title="Ver detalle">
                        <i class="fas fa-eye"></i>
                    </a>
                    {% if p.estado == 'en_revision' %}
                    <button class="action-btn action-btn--success" title="Aprobar" onclick="aprobarPago({{ p.id }})">
                        <i class="fas fa-check"></i>
                    </button>
                    <button class="action-btn action-btn--danger" title="Rechazar" onclick="rechazarPago({{ p.id }})">
                        <i class="fas fa-times"></i>
                    </button>
                    {% endif %}
                    {% if p.comprobante_path %}
                    <a href="/{{ p.comprobante_path }}" target="_blank" class="action-btn" title="Ver comprobante">
                        <i class="fas fa-paperclip"></i>
                    </a>
                    {% endif %}
                </div>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% else %}
<div class="empty-state">
    <div class="empty-state__icon"><i class="fas fa-receipt"></i></div>
    <h3 class="empty-state__title">No hay pagos</h3>
    <p class="empty-state__description">No se encontraron pagos con los filtros seleccionados.</p>
    {% if filtros.estado or filtros.cliente_id %}
    <a href="{{ url_for('boletas.pagos_lista') }}" class="btn btn--secondary">Limpiar Filtros</a>
    {% endif %}
</div>
{% endif %}

<script>
if (window.FilterBar) {
    FilterBar.init('#filterFormPagos', { debounceMs: 400, containerSelector: '.data-table' });
}

function aprobarPago(pagoId) {
    ConfirmModal.show({
        title: 'Aprobar Pago',
        message: 'Se aprobara este pago y se aplicara a las boletas correspondientes.',
        icon: 'success',
        confirmText: 'Aprobar',
        confirmClass: 'btn--success'
    }).then(function(ok) {
        if (ok) {
            var form = document.createElement('form');
            form.method = 'POST';
            form.action = '/boletas/pagos/' + pagoId + '/aprobar';
            document.body.appendChild(form);
            form.submit();
        }
    });
}

function rechazarPago(pagoId) {
    ConfirmModal.show({
        title: 'Rechazar Pago',
        message: 'El pago sera rechazado y las boletas volveran a estado pendiente.',
        icon: 'danger',
        confirmText: 'Rechazar',
        confirmClass: 'btn--danger',
        showInput: true,
        inputLabel: 'Motivo del rechazo:',
        inputPlaceholder: 'Ingrese el motivo...',
        inputRequired: true
    }).then(function(motivo) {
        if (motivo) {
            var form = document.createElement('form');
            form.method = 'POST';
            form.action = '/boletas/pagos/' + pagoId + '/rechazar';
            var input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'motivo';
            input.value = motivo;
            form.appendChild(input);
            document.body.appendChild(form);
            form.submit();
        }
    });
}
</script>
{% endblock %}
