{% extends "base.html" %}

{% block title %}Pagos - Sistema de Lecturas{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Historial de Pagos</h1>
    <div>
        <a href="{{ url_for('boletas.registrar_pago_admin') }}" class="btn btn-primary">Registrar Pago</a>
        <a href="{{ url_for('boletas.saldos_lista') }}" class="btn btn-secondary">Ver Saldos</a>
        <a href="{{ url_for('boletas.listar') }}" class="btn btn-secondary">Volver a Boletas</a>
    </div>
</div>

<form method="GET" class="filter-form" style="margin-bottom: 20px; padding: 15px; background: #f5f5f5; border-radius: 5px;">
    <div style="display: flex; flex-wrap: wrap; gap: 10px; align-items: end;">
        <div class="form-group" style="margin: 0;">
            <label for="estado">Estado</label>
            <select name="estado" id="estado" onchange="this.form.submit()">
                <option value="">Todos</option>
                <option value="pendiente" {{ 'selected' if filtros.estado == 'pendiente' }}>Pendientes</option>
                <option value="en_revision" {{ 'selected' if filtros.estado == 'en_revision' }}>En Revision</option>
                <option value="aprobado" {{ 'selected' if filtros.estado == 'aprobado' }}>Aprobados</option>
                <option value="rechazado" {{ 'selected' if filtros.estado == 'rechazado' }}>Rechazados</option>
            </select>
        </div>
        <div class="form-group" style="margin: 0;">
            <label for="cliente_id">Cliente</label>
            <select name="cliente_id" id="cliente_id" onchange="this.form.submit()">
                <option value="">Todos los clientes</option>
                {% for c in clientes %}
                <option value="{{ c.id }}" {{ 'selected' if filtros.cliente_id == c.id }}>{{ c.nombre }}</option>
                {% endfor %}
            </select>
        </div>
        {% if filtros.estado or filtros.cliente_id %}
        <a href="{{ url_for('boletas.pagos_lista') }}" class="btn btn-secondary">Limpiar</a>
        {% endif %}
    </div>
</form>

<p class="total-results">Mostrando {{ pagos|length }} pago(s)</p>

{% if pagos %}
<table class="data-table">
    <thead>
        <tr>
            <th>N Pago</th>
            <th>Cliente</th>
            <th>Monto</th>
            <th>Aplicado</th>
            <th>Saldo Favor</th>
            <th>Metodo</th>
            <th>Fecha Envio</th>
            <th>Estado</th>
            <th>Boletas</th>
            <th>Acciones</th>
        </tr>
    </thead>
    <tbody>
        {% for p in pagos %}
        <tr>
            <td>
                <a href="{{ url_for('boletas.pago_detalle', pago_id=p.id) }}">
                    {{ p.numero_pago }}
                </a>
            </td>
            <td>{{ p.cliente_nombre }}</td>
            <td>${{ p.monto_total|formato_pesos }}</td>
            <td>${{ p.monto_aplicado|formato_pesos }}</td>
            <td>
                {% if p.monto_a_favor > 0 %}
                <span style="color: #28a745;">${{ p.monto_a_favor|formato_pesos }}</span>
                {% else %}
                -
                {% endif %}
            </td>
            <td>{{ p.metodo_pago|capitalize if p.metodo_pago else '-' }}</td>
            <td>{{ p.fecha_envio }}</td>
            <td>
                {% if p.estado == 'aprobado' %}
                    <span class="badge badge-success">Aprobado</span>
                {% elif p.estado == 'rechazado' %}
                    <span class="badge badge-danger">Rechazado</span>
                {% elif p.estado == 'en_revision' %}
                    <span class="badge badge-warning">En Revision</span>
                {% else %}
                    <span class="badge badge-secondary">{{ p.estado|capitalize }}</span>
                {% endif %}
            </td>
            <td>{{ p.num_boletas }}</td>
            <td class="actions">
                <a href="{{ url_for('boletas.pago_detalle', pago_id=p.id) }}" class="btn btn-small">Ver</a>
                {% if p.estado == 'en_revision' %}
                <form action="{{ url_for('boletas.aprobar_pago_route', pago_id=p.id) }}" method="POST" style="display: inline;">
                    <button type="submit" class="btn btn-small btn-success" onclick="return confirm('Aprobar este pago?')">Aprobar</button>
                </form>
                <button type="button" class="btn btn-small btn-danger" onclick="abrirModalRechazo({{ p.id }})">Rechazar</button>
                {% endif %}
                {% if p.comprobante_path %}
                <a href="/{{ p.comprobante_path }}" target="_blank" class="btn btn-small">Comprobante</a>
                {% endif %}
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% else %}
<div style="text-align: center; padding: 40px; background: #f9f9f9; border-radius: 5px;">
    <p>No hay pagos registrados.</p>
</div>
{% endif %}

<!-- Modal para rechazar pago -->
<div id="modalRechazo" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Rechazar Pago</h3>
            <button onclick="cerrarModalRechazo()" class="close-btn">&times;</button>
        </div>
        <div class="modal-body">
            <form id="formRechazo" method="POST">
                <div class="form-group">
                    <label for="motivo">Motivo del rechazo *</label>
                    <textarea name="motivo" id="motivo" required rows="3" style="width: 100%; padding: 8px;"></textarea>
                </div>
                <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="button" onclick="cerrarModalRechazo()" class="btn btn-secondary">Cancelar</button>
                    <button type="submit" class="btn btn-danger">Rechazar Pago</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function abrirModalRechazo(pagoId) {
    document.getElementById('formRechazo').action = `/boletas/pagos/${pagoId}/rechazar`;
    document.getElementById('modalRechazo').style.display = 'flex';
}

function cerrarModalRechazo() {
    document.getElementById('modalRechazo').style.display = 'none';
    document.getElementById('formRechazo').reset();
}

window.onclick = function(event) {
    const modal = document.getElementById('modalRechazo');
    if (event.target === modal) {
        cerrarModalRechazo();
    }
}

document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        cerrarModalRechazo();
    }
});
</script>

<style>
.badge {
    display: inline-block;
    padding: 3px 8px;
    border-radius: 3px;
    font-size: 12px;
    font-weight: bold;
}
.badge-success { background: #28a745; color: white; }
.badge-warning { background: #ffc107; color: black; }
.badge-danger { background: #dc3545; color: white; }
.badge-secondary { background: #6c757d; color: white; }
.btn-small {
    padding: 3px 8px;
    font-size: 12px;
}
.btn-success { background: #28a745; color: white; border: none; }
.btn-danger { background: #dc3545; color: white; border: none; }

.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    align-items: center;
    justify-content: center;
}
.modal-content {
    background-color: white;
    border-radius: 8px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    width: 90%;
    max-width: 500px;
}
.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px;
    border-bottom: 1px solid #ddd;
}
.modal-header h3 { margin: 0; }
.close-btn {
    background: none;
    border: none;
    font-size: 28px;
    cursor: pointer;
    color: #aaa;
}
.close-btn:hover { color: #000; }
.modal-body { padding: 20px; }
</style>
{% endblock %}
