{% extends "base.html" %}

{% block title %}Historial de Pagos - Sistema de Lecturas{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Historial de Pagos</h1>
    <div>
        <a href="{{ url_for('boletas.listar') }}" class="btn btn-secondary">Volver a Boletas</a>
    </div>
</div>

<form method="GET" class="filter-form" style="margin-bottom: 20px; padding: 15px; background: #f5f5f5; border-radius: 5px;">
    <div style="display: flex; flex-wrap: wrap; gap: 10px; align-items: end;">
        <div class="form-group" style="margin: 0;">
            <label for="estado">Filtrar por Estado</label>
            <select name="estado" id="estado" onchange="this.form.submit()">
                <option value="">Todos</option>
                <option value="en_revision" {{ 'selected' if estado_filtro == 'en_revision' }}>En Revision</option>
                <option value="aprobado" {{ 'selected' if estado_filtro == 'aprobado' }}>Aprobados</option>
                <option value="rechazado" {{ 'selected' if estado_filtro == 'rechazado' }}>Rechazados</option>
            </select>
        </div>
    </div>
</form>

{% if historial %}
<table class="data-table">
    <thead>
        <tr>
            <th>#</th>
            <th>Boleta</th>
            <th>Cliente</th>
            <th>Total</th>
            <th>Fecha Envio</th>
            <th>Estado</th>
            <th>Fecha Proceso</th>
            <th>Detalle</th>
            <th>Comprobante</th>
            <th>Acciones</th>
        </tr>
    </thead>
    <tbody>
        {% for h in historial %}
        <tr>
            <td>{{ h.id }}</td>
            <td>
                <a href="{{ url_for('boletas.detalle', boleta_id=h.boleta_id) }}">
                    {{ h.numero_boleta }}
                </a>
            </td>
            <td>{{ h.cliente_nombre }}</td>
            <td>${{ h.total|formato_pesos }}</td>
            <td>{{ h.fecha_envio }}</td>
            <td>
                {% if h.estado == 'aprobado' %}
                    <span class="badge badge-success">Aprobado</span>
                {% elif h.estado == 'rechazado' %}
                    <span class="badge badge-danger">Rechazado</span>
                {% else %}
                    <span class="badge badge-warning">En Revision</span>
                {% endif %}
            </td>
            <td>{{ h.fecha_procesamiento or '-' }}</td>
            <td>
                {% if h.estado == 'rechazado' %}
                    <small>{{ h.motivo_rechazo }}</small>
                {% elif h.estado == 'aprobado' %}
                    <small>{{ h.metodo_pago|capitalize if h.metodo_pago else '-' }}</small>
                {% else %}
                    -
                {% endif %}
            </td>
            <td>
                <a href="/{{ h.comprobante_path }}" target="_blank">Ver</a>
            </td>
            <td>
                <a href="{{ url_for('boletas.detalle', boleta_id=h.boleta_id) }}" class="btn btn-small">Ver Boleta</a>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% else %}
<div style="text-align: center; padding: 40px; background: #f9f9f9; border-radius: 5px;">
    <p>No hay registros en el historial de pagos.</p>
    <p class="text-muted">Los registros apareceran cuando los clientes envien comprobantes desde el portal.</p>
</div>
{% endif %}

<style>
.badge {
    display: inline-block;
    padding: 3px 8px;
    border-radius: 3px;
    font-size: 12px;
    font-weight: bold;
}
.badge-success { background: #28a745; color: white; }
.badge-warning { background: #ffc107; color: black; }
.badge-danger { background: #dc3545; color: white; }
.btn-small {
    padding: 3px 8px;
    font-size: 12px;
}
</style>
{% endblock %}
