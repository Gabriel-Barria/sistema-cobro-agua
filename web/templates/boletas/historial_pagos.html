{% extends "base.html" %}

{% block title %}Historial de Pagos - Sistema de Lecturas{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Historial de Pagos</h1>
    <a href="{{ url_for('boletas.listar') }}" class="btn btn--secondary">Volver a Boletas</a>
</div>

<form method="GET" class="filter-bar" id="filterFormHistorial">
    <div class="filter-bar__fields">
        <div class="filter-bar__group">
            <label for="estado">Estado</label>
            <select name="estado" id="estado">
                <option value="">Todos</option>
                <option value="en_revision" {{ 'selected' if estado_filtro == 'en_revision' }}>En Revision</option>
                <option value="aprobado" {{ 'selected' if estado_filtro == 'aprobado' }}>Aprobados</option>
                <option value="rechazado" {{ 'selected' if estado_filtro == 'rechazado' }}>Rechazados</option>
            </select>
        </div>
    </div>
    <div class="filter-bar__actions">
        <button type="submit" class="btn btn--primary">Filtrar</button>
        {% if estado_filtro %}
        <a href="{{ url_for('boletas.historial_pagos') }}" class="btn btn--secondary">Limpiar</a>
        {% endif %}
    </div>
</form>

{% if historial %}
<table class="data-table data-table--striped data-table--hover">
    <thead>
        <tr>
            <th>#</th>
            <th>Boleta</th>
            <th>Cliente</th>
            <th>Total</th>
            <th>Fecha Envio</th>
            <th>Estado</th>
            <th>Fecha Proceso</th>
            <th>Detalle</th>
            <th>Comprobante</th>
            <th>Acciones</th>
        </tr>
    </thead>
    <tbody>
        {% for h in historial %}
        <tr>
            <td>{{ h.id }}</td>
            <td>
                <a href="{{ url_for('boletas.detalle', boleta_id=h.boleta_id) }}">
                    {{ h.numero_boleta }}
                </a>
            </td>
            <td>{{ h.cliente_nombre }}</td>
            <td>${{ h.total|formato_pesos }}</td>
            <td>{{ h.fecha_envio }}</td>
            <td>
                {% if h.estado == 'aprobado' %}
                    <span class="badge badge--success">Aprobado</span>
                {% elif h.estado == 'rechazado' %}
                    <span class="badge badge--danger">Rechazado</span>
                {% else %}
                    <span class="badge badge--warning">En Revision</span>
                {% endif %}
            </td>
            <td>{{ h.fecha_procesamiento or '-' }}</td>
            <td>
                {% if h.estado == 'rechazado' %}
                    <small>{{ h.motivo_rechazo }}</small>
                {% elif h.estado == 'aprobado' %}
                    <small>{{ h.metodo_pago|capitalize if h.metodo_pago else '-' }}</small>
                {% else %}
                    -
                {% endif %}
            </td>
            <td>
                <a href="/{{ h.comprobante_path }}" target="_blank" class="action-btn" title="Ver comprobante">
                    <i class="fas fa-paperclip"></i>
                </a>
            </td>
            <td>
                <a href="{{ url_for('boletas.detalle', boleta_id=h.boleta_id) }}" class="action-btn" title="Ver boleta">
                    <i class="fas fa-eye"></i>
                </a>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% else %}
<div class="empty-state">
    <div class="empty-state__icon"><i class="fas fa-history"></i></div>
    <h3 class="empty-state__title">Sin historial</h3>
    <p class="empty-state__description">No hay registros en el historial de pagos. Los registros apareceran cuando los clientes envien comprobantes desde el portal.</p>
    {% if estado_filtro %}
    <a href="{{ url_for('boletas.historial_pagos') }}" class="btn btn--secondary">Limpiar Filtros</a>
    {% endif %}
</div>
{% endif %}

<script>
if (window.FilterBar) {
    FilterBar.init('#filterFormHistorial', { debounceMs: 400, containerSelector: '.data-table' });
}
</script>
{% endblock %}
