{% extends "base.html" %}

{% block title %}Historial de Pagos - Sistema de Lecturas{% endblock %}

{% block content %}
<!-- HEADER -->
<div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6">
    <h1 class="text-2xl font-bold">Historial de Pagos</h1>
    <a href="{{ url_for('boletas.listar') }}" class="btn btn-ghost">
        <i class="fas fa-arrow-left"></i>
        <span class="hidden sm:inline">Volver a Boletas</span>
    </a>
</div>

<!-- FILTERS -->
<div class="card bg-base-100 shadow mb-4">
    <div class="card-body py-4">
        <form method="GET" id="filterFormHistorial" class="flex flex-wrap gap-4 items-end">
            <div class="form-control">
                <label class="label">
                    <span class="label-text">Estado</span>
                </label>
                <select name="estado" id="estado" class="select select-bordered select-sm">
                    <option value="">Todos</option>
                    <option value="en_revision" {{ 'selected' if estado_filtro == 'en_revision' }}>En Revision</option>
                    <option value="aprobado" {{ 'selected' if estado_filtro == 'aprobado' }}>Aprobados</option>
                    <option value="rechazado" {{ 'selected' if estado_filtro == 'rechazado' }}>Rechazados</option>
                </select>
            </div>
            <div class="flex gap-2">
                <button type="submit" class="btn btn-primary btn-sm">
                    <i class="fas fa-filter"></i> Filtrar
                </button>
                {% if estado_filtro %}
                <a href="{{ url_for('boletas.historial_pagos') }}" class="btn btn-ghost btn-sm">Limpiar</a>
                {% endif %}
            </div>
        </form>
    </div>
</div>

{% if historial %}
<!-- TABLE - desktop -->
<div class="overflow-x-auto hidden lg:block">
    <table class="table table-zebra bg-base-100">
        <thead>
            <tr>
                <th>#</th>
                <th>Boleta</th>
                <th>Cliente</th>
                <th>Total</th>
                <th>Fecha Envio</th>
                <th>Estado</th>
                <th>Fecha Proceso</th>
                <th>Detalle</th>
                <th>Comprobante</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody>
            {% for h in historial %}
            <tr class="hover">
                <td>{{ h.id }}</td>
                <td>
                    <a href="{{ url_for('boletas.detalle', boleta_id=h.boleta_id) }}" class="link link-primary">
                        {{ h.numero_boleta }}
                    </a>
                </td>
                <td>{{ h.cliente_nombre }}</td>
                <td>${{ h.total|formato_pesos }}</td>
                <td>{{ h.fecha_envio }}</td>
                <td>
                    {% if h.estado == 'aprobado' %}
                        <span class="badge badge-success">Aprobado</span>
                    {% elif h.estado == 'rechazado' %}
                        <span class="badge badge-error">Rechazado</span>
                    {% else %}
                        <span class="badge badge-warning">En Revision</span>
                    {% endif %}
                </td>
                <td>{{ h.fecha_procesamiento or '-' }}</td>
                <td>
                    {% if h.estado == 'rechazado' %}
                        <small>{{ h.motivo_rechazo }}</small>
                    {% elif h.estado == 'aprobado' %}
                        <small>{{ h.metodo_pago|capitalize if h.metodo_pago else '-' }}</small>
                    {% else %}
                        -
                    {% endif %}
                </td>
                <td>
                    <a href="/{{ h.comprobante_path }}" target="_blank" class="btn btn-ghost btn-xs btn-square" title="Ver comprobante">
                        <i class="fas fa-paperclip"></i>
                    </a>
                </td>
                <td>
                    <a href="{{ url_for('boletas.detalle', boleta_id=h.boleta_id) }}" class="btn btn-ghost btn-xs btn-square" title="Ver boleta">
                        <i class="fas fa-eye"></i>
                    </a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- CARDS - mobile -->
<div class="lg:hidden space-y-2">
    {% for h in historial %}
    <div class="card bg-base-100 shadow">
        <div class="card-body py-4 px-4">
            <div class="flex items-center justify-between mb-2">
                <a href="{{ url_for('boletas.detalle', boleta_id=h.boleta_id) }}" class="font-semibold link link-primary">
                    {{ h.numero_boleta }}
                </a>
                {% if h.estado == 'aprobado' %}
                    <span class="badge badge-success">Aprobado</span>
                {% elif h.estado == 'rechazado' %}
                    <span class="badge badge-error">Rechazado</span>
                {% else %}
                    <span class="badge badge-warning">En Revision</span>
                {% endif %}
            </div>
            <div class="text-sm text-base-content/70">{{ h.cliente_nombre }}</div>
            <div class="flex items-center justify-between mt-2">
                <span class="font-bold">${{ h.total|formato_pesos }}</span>
                <span class="text-sm text-base-content/70">{{ h.fecha_envio }}</span>
            </div>
            <div class="flex gap-2 mt-3">
                <a href="/{{ h.comprobante_path }}" target="_blank" class="btn btn-ghost btn-sm">
                    <i class="fas fa-paperclip"></i> Comprobante
                </a>
                <a href="{{ url_for('boletas.detalle', boleta_id=h.boleta_id) }}" class="btn btn-ghost btn-sm">
                    <i class="fas fa-eye"></i> Ver
                </a>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

{% else %}
<div class="card bg-base-100 shadow">
    <div class="card-body items-center text-center py-12">
        <i class="fas fa-history text-5xl text-base-content/30 mb-4"></i>
        <h3 class="card-title">Sin historial</h3>
        <p class="text-base-content/70 mb-4">No hay registros en el historial de pagos. Los registros apareceran cuando los clientes envien comprobantes desde el portal.</p>
        {% if estado_filtro %}
        <a href="{{ url_for('boletas.historial_pagos') }}" class="btn btn-ghost">Limpiar Filtros</a>
        {% endif %}
    </div>
</div>
{% endif %}

<script>
if (window.FilterBar) {
    FilterBar.init('#filterFormHistorial', { debounceMs: 400, containerSelector: '.table' });
}
</script>
{% endblock %}
