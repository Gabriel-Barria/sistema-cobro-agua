{% extends "portal/base_portal.html" %}

{% block content %}
<!-- Info del cliente -->
<div class="card bg-base-100 shadow mb-4">
    <div class="card-body py-4">
        <div class="flex flex-wrap gap-4 items-center">
            <div class="flex items-center gap-2">
                <i class="fas fa-user text-primary"></i>
                <span class="font-medium">{{ cliente.nombre }}</span>
            </div>
            <div class="flex items-center gap-2 text-base-content/70">
                <i class="fas fa-id-card"></i>
                <span>{{ session.get('cliente_rut') }}</span>
            </div>
        </div>
    </div>
</div>

{% if boletas_pendientes %}
<!-- Sticky Bar de Pago -->
<div class="fixed bottom-0 left-0 right-0 bg-base-100 border-t border-base-300 shadow-lg z-50 p-4">
    <div class="container mx-auto max-w-4xl flex items-center justify-between gap-4">
        <div class="flex flex-col sm:flex-row sm:items-center gap-1 sm:gap-4">
            <span class="text-sm text-base-content/70">
                {{ boletas_pendientes|length }} boleta{% if boletas_pendientes|length > 1 %}s{% endif %} pendiente{% if boletas_pendientes|length > 1 %}s{% endif %}
            </span>
            <span class="text-xl font-bold text-primary" id="totalStickyBar">$0</span>
        </div>
        <button type="button" class="btn btn-primary" onclick="abrirModalPago()" id="btnPagar">
            <i class="fas fa-credit-card mr-2"></i>
            Pagar
        </button>
    </div>
</div>

<!-- Select All -->
<div class="card bg-base-100 shadow mb-4">
    <div class="card-body py-3">
        <label class="flex items-center gap-3 cursor-pointer">
            <input type="checkbox" id="selectAll" class="checkbox checkbox-primary" onclick="toggleAll(this)">
            <span class="font-medium">Seleccionar todas</span>
        </label>
    </div>
</div>

<!-- Lista de Boletas Pendientes -->
<div class="space-y-3 pb-24">
    {% for boleta in boletas_pendientes %}
    <div class="card bg-base-100 shadow {% if boleta.ultimo_rechazo %}border-l-4 border-error{% endif %}" data-total="{{ boleta.total }}">
        <div class="card-body py-4 px-4">
            <div class="flex items-center gap-3">
                <input type="checkbox" name="boletas" value="{{ boleta.id }}"
                       class="checkbox checkbox-primary boleta-check" onchange="actualizarTotal()">

                <div class="flex-1 min-w-0">
                    <div class="flex flex-wrap items-center gap-2">
                        <span class="font-semibold">N° {{ boleta.numero_boleta }}</span>
                        <span class="badge badge-ghost">{{ boleta.periodo_mes|mes_nombre }} {{ boleta.periodo_año }}</span>
                    </div>
                </div>

                <div class="text-right">
                    <span class="text-lg font-bold text-primary">${{ boleta.total|formato_pesos }}</span>
                </div>

                <div class="flex items-center gap-1">
                    <a href="{{ url_for('portal.descargar_boleta', boleta_id=boleta.id) }}"
                       class="btn btn-ghost btn-sm btn-circle" title="Descargar PDF">
                        <i class="fas fa-download"></i>
                    </a>
                    <button type="button" class="btn btn-ghost btn-sm btn-circle btn-expandir"
                            onclick="toggleDetalle({{ boleta.id }})" title="Ver detalle">
                        <i class="fas fa-chevron-down transition-transform duration-200"></i>
                    </button>
                </div>
            </div>

            <!-- Detalle expandible -->
            <div class="hidden mt-4 pt-4 border-t border-base-300" id="detalle-{{ boleta.id }}">
                <div class="grid grid-cols-3 gap-4 text-sm">
                    <div class="text-center">
                        <div class="text-base-content/60">Consumo</div>
                        <div class="font-semibold">{{ boleta.consumo_m3 }} m3</div>
                    </div>
                    <div class="text-center">
                        <div class="text-base-content/60">Cargo fijo</div>
                        <div class="font-semibold">${{ boleta.cargo_fijo|formato_pesos }}</div>
                    </div>
                    <div class="text-center">
                        <div class="text-base-content/60">Precio m3</div>
                        <div class="font-semibold">${{ boleta.precio_m3|formato_pesos }}</div>
                    </div>
                </div>
                {% if boleta.ultimo_rechazo %}
                <div class="alert alert-error mt-4">
                    <i class="fas fa-exclamation-triangle"></i>
                    <div>
                        <div class="font-semibold">Pago rechazado:</div>
                        <div>{{ boleta.ultimo_rechazo.motivo_rechazo }}</div>
                        <a href="/{{ boleta.ultimo_rechazo.comprobante_path }}" target="_blank" class="link link-primary">
                            Ver comprobante anterior
                        </a>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    {% endfor %}
</div>

{% else %}
<div class="card bg-base-100 shadow-xl">
    <div class="card-body items-center text-center py-12">
        <div class="text-6xl text-success mb-4">
            <i class="fas fa-check-circle"></i>
        </div>
        <h3 class="card-title text-2xl">No tiene boletas pendientes de pago</h3>
        <p class="text-base-content/70">Todas sus boletas estan al dia.</p>
    </div>
</div>
{% endif %}

{% if boletas_en_revision %}
<!-- Seccion En Revision (colapsada por defecto) -->
<div class="collapse collapse-arrow bg-base-100 shadow mt-6 {% if boletas_pendientes %}{% endif %}">
    <input type="checkbox" />
    <div class="collapse-title font-medium">
        <span class="badge badge-warning mr-2">{{ boletas_en_revision|length }}</span>
        Boletas en revision
    </div>
    <div class="collapse-content">
        <div class="space-y-3 pt-2">
            {% for boleta in boletas_en_revision %}
            <div class="card bg-base-200">
                <div class="card-body py-3 px-4">
                    <div class="flex items-center gap-3">
                        <div class="flex-1">
                            <div class="flex flex-wrap items-center gap-2">
                                <span class="font-semibold">N° {{ boleta.numero_boleta }}</span>
                                <span class="badge badge-warning badge-sm">En revision</span>
                            </div>
                            <div class="text-sm text-base-content/60 mt-1">
                                Enviado: {{ boleta.intento_actual.fecha_envio if boleta.intento_actual else '-' }}
                                {% if boleta.comprobante_path %}
                                <a href="/{{ boleta.comprobante_path }}" target="_blank" class="link link-primary ml-2">
                                    Ver comprobante
                                </a>
                                {% endif %}
                            </div>
                        </div>
                        <div class="text-right">
                            <span class="text-lg font-bold">${{ boleta.total|formato_pesos }}</span>
                        </div>
                        <a href="{{ url_for('portal.descargar_boleta', boleta_id=boleta.id) }}"
                           class="btn btn-ghost btn-sm btn-circle" title="Descargar PDF">
                            <i class="fas fa-download"></i>
                        </a>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endif %}

<!-- Modal de Pago usando DaisyUI -->
<dialog id="modalPago" class="modal">
    <div class="modal-box">
        <form method="dialog">
            <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">
                <i class="fas fa-times"></i>
            </button>
        </form>
        <h3 class="font-bold text-lg mb-4">
            <i class="fas fa-credit-card text-primary mr-2"></i>
            Confirmar Pago
        </h3>

        <form method="POST" action="{{ url_for('portal.pagar') }}"
              enctype="multipart/form-data" id="formPago">
            <div class="bg-base-200 rounded-lg p-4 mb-4">
                <div class="text-center">
                    <p class="text-base-content/70">
                        <span id="cantidadSeleccionadas">0</span> boleta(s) seleccionada(s)
                    </p>
                    <p class="text-2xl font-bold text-primary mt-2">
                        Total: <span id="totalModal">$0</span>
                    </p>
                </div>
            </div>

            <div class="form-control w-full mb-4">
                <label class="label" for="comprobante">
                    <span class="label-text font-medium">Comprobante de pago:</span>
                </label>
                <input type="file" name="comprobante" id="comprobante"
                       class="file-input file-input-bordered w-full"
                       accept=".png,.jpg,.jpeg,.pdf" required>
                <label class="label">
                    <span class="label-text-alt text-base-content/60">PNG, JPG o PDF (max. 5MB)</span>
                </label>
            </div>

            <!-- Hidden inputs para boletas seleccionadas -->
            <div id="boletasHidden"></div>

            <div class="modal-action">
                <button type="button" class="btn btn-ghost" onclick="cerrarModalPago()">
                    Cancelar
                </button>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-paper-plane mr-2"></i>
                    Enviar Pago
                </button>
            </div>
        </form>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>close</button>
    </form>
</dialog>

<script>
function toggleAll(checkbox) {
    const checks = document.querySelectorAll('.boleta-check');
    checks.forEach(c => c.checked = checkbox.checked);
    actualizarTotal();
}

function actualizarTotal() {
    const checks = document.querySelectorAll('.boleta-check:checked');
    let total = 0;
    let count = 0;

    checks.forEach(check => {
        const item = check.closest('.card');
        const totalValue = parseInt(item.dataset.total) || 0;
        total += totalValue;
        count++;
    });

    const formatted = total.toLocaleString('es-CL');

    // Actualizar sticky bar
    document.getElementById('totalStickyBar').textContent = '$' + formatted;

    // Actualizar modal
    document.getElementById('totalModal').textContent = '$' + formatted;
    document.getElementById('cantidadSeleccionadas').textContent = count;

    // Actualizar boton pagar
    const btnPagar = document.getElementById('btnPagar');
    if (btnPagar) {
        if (count > 0) {
            btnPagar.innerHTML = '<i class="fas fa-credit-card mr-2"></i>Pagar $' + formatted;
            btnPagar.disabled = false;
            btnPagar.classList.remove('btn-disabled');
        } else {
            btnPagar.innerHTML = '<i class="fas fa-credit-card mr-2"></i>Pagar';
            btnPagar.disabled = true;
            btnPagar.classList.add('btn-disabled');
        }
    }
}

function toggleDetalle(boletaId) {
    const detalle = document.getElementById('detalle-' + boletaId);
    const btn = detalle.closest('.card-body').querySelector('.btn-expandir i');

    if (detalle.classList.contains('hidden')) {
        detalle.classList.remove('hidden');
        btn.classList.add('rotate-180');
    } else {
        detalle.classList.add('hidden');
        btn.classList.remove('rotate-180');
    }
}

function abrirModalPago() {
    const checks = document.querySelectorAll('.boleta-check:checked');
    if (checks.length === 0) {
        alert('Debe seleccionar al menos una boleta');
        return;
    }

    // Copiar boletas seleccionadas al form del modal
    const container = document.getElementById('boletasHidden');
    container.innerHTML = '';
    checks.forEach(check => {
        const hidden = document.createElement('input');
        hidden.type = 'hidden';
        hidden.name = 'boletas';
        hidden.value = check.value;
        container.appendChild(hidden);
    });

    document.getElementById('modalPago').showModal();
}

function cerrarModalPago() {
    document.getElementById('modalPago').close();
}

// Validar formulario
document.getElementById('formPago').addEventListener('submit', function(e) {
    const comprobante = document.getElementById('comprobante');
    if (!comprobante.files.length) {
        e.preventDefault();
        alert('Debe adjuntar un comprobante de pago');
        return;
    }

    if (comprobante.files[0].size > 5 * 1024 * 1024) {
        e.preventDefault();
        alert('El archivo no debe superar 5MB');
        return;
    }
});

// Inicializar total al cargar
document.addEventListener('DOMContentLoaded', function() {
    actualizarTotal();
});
</script>
{% endblock %}
