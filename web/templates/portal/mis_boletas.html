{% extends "portal/base_portal.html" %}

{% block content %}
<div class="cliente-info">
    <p><strong>Cliente:</strong> {{ cliente.nombre }}</p>
    <p><strong>RUT:</strong> {{ session.get('cliente_rut') }}</p>
</div>

{% if boletas_pendientes %}
<!-- Sticky Bar de Pago -->
<div class="pago-sticky-bar">
    <div class="pago-sticky-info">
        <span class="pago-sticky-count">{{ boletas_pendientes|length }} boleta{% if boletas_pendientes|length > 1 %}s{% endif %} pendiente{% if boletas_pendientes|length > 1 %}s{% endif %}</span>
        <span class="pago-sticky-total" id="totalStickyBar">$0</span>
    </div>
    <button type="button" class="btn btn-primary btn-pagar" onclick="abrirModalPago()">
        Pagar
    </button>
</div>

<!-- Select All -->
<div class="select-all-bar">
    <input type="checkbox" id="selectAll" onclick="toggleAll(this)">
    <label for="selectAll">Seleccionar todas</label>
</div>

<!-- Lista de Boletas Pendientes -->
<div class="boletas-lista-compact">
    {% for boleta in boletas_pendientes %}
    <div class="boleta-item {% if boleta.ultimo_rechazo %}boleta-rechazada{% endif %}" data-total="{{ boleta.total }}">
        <div class="boleta-row">
            <input type="checkbox" name="boletas" value="{{ boleta.id }}"
                   class="boleta-check" onchange="actualizarTotal()">
            <div class="boleta-info-compact">
                <span class="boleta-numero">N° {{ boleta.numero_boleta }}</span>
                <span class="boleta-periodo">{{ boleta.periodo_mes|mes_nombre }} {{ boleta.periodo_año }}</span>
            </div>
            <div class="boleta-monto">${{ boleta.total|formato_pesos }}</div>
            <div class="boleta-acciones">
                <a href="{{ url_for('portal.descargar_boleta', boleta_id=boleta.id) }}"
                   class="btn-icon" title="Descargar PDF">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                        <polyline points="7 10 12 15 17 10"/>
                        <line x1="12" y1="15" x2="12" y2="3"/>
                    </svg>
                </a>
                <button type="button" class="btn-icon btn-expandir"
                        onclick="toggleDetalle({{ boleta.id }})" title="Ver detalle">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="6 9 12 15 18 9"/>
                    </svg>
                </button>
            </div>
        </div>

        <!-- Detalle expandible -->
        <div class="boleta-detalle" id="detalle-{{ boleta.id }}">
            <div class="detalle-grid">
                <div class="detalle-item">
                    <span class="detalle-label">Consumo</span>
                    <span class="detalle-value">{{ boleta.consumo_m3 }} m3</span>
                </div>
                <div class="detalle-item">
                    <span class="detalle-label">Cargo fijo</span>
                    <span class="detalle-value">${{ boleta.cargo_fijo|formato_pesos }}</span>
                </div>
                <div class="detalle-item">
                    <span class="detalle-label">Precio m3</span>
                    <span class="detalle-value">${{ boleta.precio_m3|formato_pesos }}</span>
                </div>
            </div>
            {% if boleta.ultimo_rechazo %}
            <div class="alerta-rechazo">
                <strong>Pago rechazado:</strong> {{ boleta.ultimo_rechazo.motivo_rechazo }}
                <br><a href="/{{ boleta.ultimo_rechazo.comprobante_path }}" target="_blank">Ver comprobante anterior</a>
            </div>
            {% endif %}
        </div>
    </div>
    {% endfor %}
</div>

{% else %}
<div class="no-boletas">
    <div class="no-boletas-icon">&#10003;</div>
    <h3>No tiene boletas pendientes de pago</h3>
    <p>Todas sus boletas estan al dia.</p>
</div>
{% endif %}

{% if boletas_en_revision %}
<!-- Seccion En Revision (colapsada por defecto) -->
<details class="seccion-revision">
    <summary>
        <span class="revision-badge">{{ boletas_en_revision|length }}</span>
        Boletas en revision
    </summary>
    <div class="boletas-lista-compact">
        {% for boleta in boletas_en_revision %}
        <div class="boleta-item en-revision">
            <div class="boleta-row">
                <div class="boleta-info-compact">
                    <span class="boleta-numero">N° {{ boleta.numero_boleta }}</span>
                    <span class="boleta-estado-tag">En revision</span>
                </div>
                <div class="boleta-monto">${{ boleta.total|formato_pesos }}</div>
                <div class="boleta-acciones">
                    <a href="{{ url_for('portal.descargar_boleta', boleta_id=boleta.id) }}"
                       class="btn-icon" title="Descargar PDF">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                            <polyline points="7 10 12 15 17 10"/>
                            <line x1="12" y1="15" x2="12" y2="3"/>
                        </svg>
                    </a>
                </div>
            </div>
            <div class="boleta-revision-info">
                <small>Enviado: {{ boleta.intento_actual.fecha_envio if boleta.intento_actual else '-' }}</small>
                {% if boleta.comprobante_path %}
                <a href="/{{ boleta.comprobante_path }}" target="_blank">Ver comprobante</a>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
</details>
{% endif %}

<!-- Modal de Pago -->
<div class="modal-overlay" id="modalPago">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Confirmar Pago</h3>
            <button type="button" class="modal-close" onclick="cerrarModalPago()">&times;</button>
        </div>
        <form method="POST" action="{{ url_for('portal.pagar') }}"
              enctype="multipart/form-data" id="formPago">
            <div class="modal-body">
                <div class="pago-resumen-modal">
                    <p><span id="cantidadSeleccionadas">0</span> boleta(s) seleccionada(s)</p>
                    <p class="total-grande">Total: <strong id="totalModal">$0</strong></p>
                </div>

                <div class="form-group">
                    <label for="comprobante" class="form-label">Comprobante de pago:</label>
                    <input type="file" name="comprobante" id="comprobante"
                           class="form-file" accept=".png,.jpg,.jpeg,.pdf" required>
                    <small class="form-hint">PNG, JPG o PDF (max. 5MB)</small>
                </div>

                <!-- Hidden inputs para boletas seleccionadas -->
                <div id="boletasHidden"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="cerrarModalPago()">
                    Cancelar
                </button>
                <button type="submit" class="btn btn-primary">
                    Enviar Pago
                </button>
            </div>
        </form>
    </div>
</div>

<script>
function toggleAll(checkbox) {
    const checks = document.querySelectorAll('.boleta-check');
    checks.forEach(c => c.checked = checkbox.checked);
    actualizarTotal();
}

function actualizarTotal() {
    const checks = document.querySelectorAll('.boleta-check:checked');
    let total = 0;
    let count = 0;

    checks.forEach(check => {
        const item = check.closest('.boleta-item');
        const totalValue = parseInt(item.dataset.total) || 0;
        total += totalValue;
        count++;
    });

    const formatted = total.toLocaleString('es-CL');

    // Actualizar sticky bar
    document.getElementById('totalStickyBar').textContent = '$' + formatted;

    // Actualizar modal
    document.getElementById('totalModal').textContent = '$' + formatted;
    document.getElementById('cantidadSeleccionadas').textContent = count;

    // Actualizar boton pagar
    const btnPagar = document.querySelector('.btn-pagar');
    if (btnPagar) {
        if (count > 0) {
            btnPagar.textContent = 'Pagar $' + formatted;
            btnPagar.disabled = false;
        } else {
            btnPagar.textContent = 'Pagar';
            btnPagar.disabled = true;
        }
    }
}

function toggleDetalle(boletaId) {
    const detalle = document.getElementById('detalle-' + boletaId);
    const btn = detalle.previousElementSibling.querySelector('.btn-expandir');

    if (detalle.classList.contains('show')) {
        detalle.classList.remove('show');
        btn.classList.remove('rotated');
    } else {
        detalle.classList.add('show');
        btn.classList.add('rotated');
    }
}

function abrirModalPago() {
    const checks = document.querySelectorAll('.boleta-check:checked');
    if (checks.length === 0) {
        alert('Debe seleccionar al menos una boleta');
        return;
    }

    // Copiar boletas seleccionadas al form del modal
    const container = document.getElementById('boletasHidden');
    container.innerHTML = '';
    checks.forEach(check => {
        const hidden = document.createElement('input');
        hidden.type = 'hidden';
        hidden.name = 'boletas';
        hidden.value = check.value;
        container.appendChild(hidden);
    });

    document.getElementById('modalPago').classList.add('show');
    document.body.style.overflow = 'hidden';
}

function cerrarModalPago() {
    document.getElementById('modalPago').classList.remove('show');
    document.body.style.overflow = '';
}

// Cerrar modal con Escape
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        cerrarModalPago();
    }
});

// Cerrar modal al hacer click fuera
document.getElementById('modalPago').addEventListener('click', function(e) {
    if (e.target === this) {
        cerrarModalPago();
    }
});

// Validar formulario
document.getElementById('formPago').addEventListener('submit', function(e) {
    const comprobante = document.getElementById('comprobante');
    if (!comprobante.files.length) {
        e.preventDefault();
        alert('Debe adjuntar un comprobante de pago');
        return;
    }

    if (comprobante.files[0].size > 5 * 1024 * 1024) {
        e.preventDefault();
        alert('El archivo no debe superar 5MB');
        return;
    }
});

// Inicializar total al cargar
document.addEventListener('DOMContentLoaded', function() {
    actualizarTotal();
});
</script>
{% endblock %}
