{% extends "base.html" %}

{% block title %}Medidores - Sistema de Cobro de Agua{% endblock %}

{% block content %}
<!-- HEADER -->
<div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6">
    <h1 class="text-2xl font-bold">Medidores</h1>
    <a href="{{ url_for('medidores.crear') }}" class="btn btn-primary">
        <i class="fas fa-plus"></i>
        <span class="hidden sm:inline">Nuevo Medidor</span>
        <span class="sm:hidden">Nuevo</span>
    </a>
</div>

<!-- STATS - colapsable -->
{% if stats %}
<div class="collapse collapse-stats collapse-arrow bg-base-100 shadow mb-4 hidden lg:block">
    <input type="checkbox" id="stats-toggle" />
    <div class="collapse-title font-medium flex items-center gap-2">
        <i class="fas fa-chart-bar text-primary"></i>
        Resumen
    </div>
    <div class="collapse-content">
        <div class="stats stats-vertical lg:stats-horizontal shadow w-full">
            <div class="stat">
                <div class="stat-title">Total</div>
                <div class="stat-value text-lg">{{ stats.total or 0 }}</div>
            </div>
            <div class="stat">
                <div class="stat-title">Activos</div>
                <div class="stat-value text-lg text-success">{{ stats.activos or 0 }}</div>
            </div>
            <div class="stat">
                <div class="stat-title">Inactivos</div>
                <div class="stat-value text-lg text-base-content/50">{{ stats.inactivos or 0 }}</div>
            </div>
            <div class="stat">
                <div class="stat-title">Total Lecturas</div>
                <div class="stat-value text-lg text-info">{{ stats.total_lecturas or 0 }}</div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- FILTER CHIPS - solo mobile -->
<div class="flex items-center gap-2 overflow-x-auto pb-4 lg:hidden">
    <a href="{{ url_for('medidores.listar') }}"
       class="btn btn-sm {% if not filtros.estado %}btn-primary{% else %}btn-ghost{% endif %}">
        Todos
        {% if stats %}<span class="badge badge-sm ml-1">{{ stats.total or 0 }}</span>{% endif %}
    </a>
    <a href="{{ url_for('medidores.listar', estado='activo', busqueda=filtros.busqueda, cliente_id=filtros.cliente_id or '') }}"
       class="btn btn-sm {% if filtros.estado == 'activo' %}btn-primary{% else %}btn-ghost{% endif %}">
        Activos
        {% if stats %}<span class="badge badge-sm ml-1">{{ stats.activos or 0 }}</span>{% endif %}
    </a>
    <a href="{{ url_for('medidores.listar', estado='inactivo', busqueda=filtros.busqueda, cliente_id=filtros.cliente_id or '') }}"
       class="btn btn-sm {% if filtros.estado == 'inactivo' %}btn-primary{% else %}btn-ghost{% endif %}">
        Inactivos
        {% if stats %}<span class="badge badge-sm ml-1">{{ stats.inactivos or 0 }}</span>{% endif %}
    </a>
    <button class="btn btn-sm btn-circle btn-ghost {% if filtros.busqueda or filtros.cliente_id %}btn-primary{% endif %}"
            onclick="modalFiltrosMedidores.showModal()" title="Filtros">
        <i class="fas fa-filter"></i>
    </button>
</div>

<!-- FILTER FORM - solo desktop -->
<form method="GET" class="card bg-base-100 shadow mb-4 hidden lg:block" id="filterFormMedidores">
    <div class="card-body py-4">
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-4 items-end">
            <div class="form-control lg:col-span-2">
                <label class="label py-1"><span class="label-text">Buscar</span></label>
                <input type="text" name="busqueda" placeholder="Buscar medidor, direccion, cliente..." value="{{ filtros.busqueda }}" class="input input-bordered input-sm">
            </div>
            <div class="form-control">
                <label class="label py-1"><span class="label-text">Cliente</span></label>
                <select name="cliente_id" class="select select-bordered select-sm">
                    <option value="">Todos los clientes</option>
                    {% for c in clientes %}
                    <option value="{{ c.id }}" {% if filtros.cliente_id == c.id %}selected{% endif %}>{{ c.nombre }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-control">
                <label class="label py-1"><span class="label-text">Estado</span></label>
                <select name="estado" class="select select-bordered select-sm">
                    <option value="">Todos los estados</option>
                    <option value="activo" {% if filtros.estado == 'activo' %}selected{% endif %}>Activos</option>
                    <option value="inactivo" {% if filtros.estado == 'inactivo' %}selected{% endif %}>Inactivos</option>
                </select>
            </div>
        </div>
        <div class="flex gap-2 mt-4">
            <button type="submit" class="btn btn-primary btn-sm">Filtrar</button>
            {% if filtros.busqueda or filtros.estado or filtros.cliente_id %}
            <a href="{{ url_for('medidores.listar') }}" class="btn btn-ghost btn-sm">Limpiar</a>
            {% endif %}
        </div>
    </div>
</form>

{% if medidores %}
<!-- CARDS - solo mobile -->
<div class="lg:hidden space-y-2" id="cardsContainer">
    {% for m in medidores %}
    <div class="collapse collapse-arrow bg-base-100 shadow {% if m.activo == 1 %}border-l-4 border-l-success{% else %}border-l-4 border-l-base-300{% endif %}">
        <input type="checkbox" class="peer" />
        <div class="collapse-title pr-12">
            <div class="flex justify-between items-center">
                <div class="min-w-0">
                    <div class="font-semibold">{{ m.numero_medidor or 'Sin numero' }}</div>
                    <div class="text-sm text-base-content/70 truncate">{{ m.cliente_nombre }}</div>
                    {% if m.direccion %}
                    <div class="text-xs text-base-content/50 truncate">{{ m.direccion }}</div>
                    {% endif %}
                </div>
                <div class="flex items-center gap-2 ml-4">
                    {% if m.activo == 1 %}
                    <span class="badge badge-success badge-sm">Activo</span>
                    {% else %}
                    <span class="badge badge-neutral badge-sm">Inactivo</span>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="collapse-content bg-base-200/50">
            <div class="grid grid-cols-2 gap-2 py-2 text-sm">
                <div class="text-base-content/70">
                    Lecturas
                    <span class="block font-medium text-base-content">{{ m.num_lecturas }}</span>
                </div>
                <div class="text-base-content/70">
                    ID
                    <span class="block font-medium text-base-content">#{{ m.id }}</span>
                </div>
            </div>
            <div class="flex flex-col gap-2 pt-2">
                <a href="{{ url_for('medidores.detalle', medidor_id=m.id) }}" class="btn btn-primary btn-sm">
                    <i class="fas fa-eye"></i> Ver Detalle
                </a>
                <a href="{{ url_for('medidores.editar', medidor_id=m.id) }}" class="btn btn-ghost btn-sm">
                    <i class="fas fa-edit"></i> Editar
                </a>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<!-- TABLE - solo desktop -->
<div class="overflow-x-auto hidden lg:block">
    <table class="table table-zebra bg-base-100">
        <thead>
            <tr>
                <th class="sortable">ID</th>
                <th class="sortable">Cliente</th>
                <th class="sortable">Numero Medidor</th>
                <th class="sortable">Direccion</th>
                <th class="sortable">Estado</th>
                <th class="sortable">Lecturas</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody>
            {% for m in medidores %}
            <tr class="hover {% if m.activo == 0 %}opacity-60{% endif %}">
                <td>{{ m.id }}</td>
                <td>
                    <a href="{{ url_for('clientes.detalle', cliente_id=m.cliente_id) }}" class="link link-primary">{{ m.cliente_nombre }}</a>
                </td>
                <td>{{ m.numero_medidor or '-' }}</td>
                <td>{{ m.direccion or '-' }}</td>
                <td>
                    {% if m.activo == 1 %}
                    <span class="badge badge-success">Activo</span>
                    {% else %}
                    <span class="badge badge-neutral">Inactivo</span>
                    {% endif %}
                </td>
                <td>{{ m.num_lecturas }}</td>
                <td>
                    <div class="flex gap-1">
                        <a href="{{ url_for('medidores.detalle', medidor_id=m.id) }}" class="btn btn-ghost btn-xs btn-square" title="Ver detalle">
                            <i class="fas fa-eye"></i>
                        </a>
                        <a href="{{ url_for('medidores.editar', medidor_id=m.id) }}" class="btn btn-ghost btn-xs btn-square" title="Editar">
                            <i class="fas fa-edit"></i>
                        </a>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

{% else %}
<!-- Empty state -->
<div class="card bg-base-100 shadow">
    <div class="card-body items-center text-center py-12">
        <i class="fas fa-gauge-high text-5xl text-base-content/30 mb-4"></i>
        <h3 class="card-title">No hay medidores</h3>
        <p class="text-base-content/70 mb-4">No se encontraron medidores con los filtros seleccionados.</p>
        <div class="card-actions">
            {% if filtros.busqueda or filtros.estado or filtros.cliente_id %}
            <a href="{{ url_for('medidores.listar') }}" class="btn btn-ghost">Limpiar Filtros</a>
            {% endif %}
            <a href="{{ url_for('medidores.crear') }}" class="btn btn-primary">+ Nuevo Medidor</a>
        </div>
    </div>
</div>
{% endif %}

<!-- Modal filtros (mobile) -->
<dialog id="modalFiltrosMedidores" class="modal modal-bottom sm:modal-middle">
    <div class="modal-box">
        <h3 class="font-bold text-lg mb-4">Filtros Avanzados</h3>
        <form method="GET">
            <div class="form-control mb-3">
                <label class="label"><span class="label-text">Busqueda</span></label>
                <input type="text" name="busqueda" value="{{ filtros.busqueda }}" placeholder="Medidor, direccion, cliente..." class="input input-bordered">
            </div>
            <div class="form-control mb-3">
                <label class="label"><span class="label-text">Cliente</span></label>
                <select name="cliente_id" class="select select-bordered">
                    <option value="">Todos los clientes</option>
                    {% for c in clientes %}
                    <option value="{{ c.id }}" {% if filtros.cliente_id == c.id %}selected{% endif %}>{{ c.nombre }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-control mb-4">
                <label class="label"><span class="label-text">Estado</span></label>
                <select name="estado" class="select select-bordered">
                    <option value="">Todos</option>
                    <option value="activo" {% if filtros.estado == 'activo' %}selected{% endif %}>Activos</option>
                    <option value="inactivo" {% if filtros.estado == 'inactivo' %}selected{% endif %}>Inactivos</option>
                </select>
            </div>
            <div class="modal-action">
                <a href="{{ url_for('medidores.listar') }}" class="btn btn-ghost">Limpiar</a>
                <button type="submit" class="btn btn-primary">Aplicar</button>
            </div>
        </form>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>close</button>
    </form>
</dialog>

<script>
// Restore stats collapse state
(function() {
    var saved = localStorage.getItem('medidores-stats-open');
    if (saved === '1') {
        var toggle = document.getElementById('stats-toggle');
        if (toggle) toggle.checked = true;
    }
    document.getElementById('stats-toggle')?.addEventListener('change', function() {
        localStorage.setItem('medidores-stats-open', this.checked ? '1' : '0');
    });
})();
</script>
{% endblock %}
