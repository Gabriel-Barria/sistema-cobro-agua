{% extends "base.html" %}

{% block title %}Medidor #{{ medidor.id }} - Sistema de Lecturas{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Medidor #{{ medidor.id }}</h1>
    <div>
        <a href="{{ url_for('medidores.editar', medidor_id=medidor.id) }}" class="btn btn--primary"><i class="fas fa-edit"></i> Editar</a>
        <button type="button" class="btn btn--danger" onclick="eliminarMedidor()"><i class="fas fa-trash"></i> Eliminar</button>
        <a href="{{ url_for('medidores.listar') }}" class="btn btn--secondary">Volver</a>
    </div>
</div>

<div class="detail-grid">
    <div class="detail-section">
        <h3>Informacion del Medidor</h3>
        <table class="detail-table">
            <tr>
                <th>Cliente:</th>
                <td><a href="{{ url_for('clientes.detalle', cliente_id=medidor.cliente_id) }}">{{ medidor.cliente_nombre }}</a></td>
            </tr>
            <tr>
                <th>Numero de Medidor:</th>
                <td>{{ medidor.numero_medidor or 'No registrado' }}</td>
            </tr>
            <tr>
                <th>Direccion:</th>
                <td>{{ medidor.direccion or 'No registrada' }}</td>
            </tr>
            <tr>
                <th>Estado:</th>
                <td>
                    {% if medidor.activo %}
                    <span class="badge badge--success">Activo</span>
                    {% else %}
                    <span class="badge badge--secondary">Inactivo</span>
                    {% endif %}
                </td>
            </tr>
            {% if medidor.fecha_inicio %}
            <tr>
                <th>Fecha de Inicio:</th>
                <td>{{ medidor.fecha_inicio|fecha_formato }}</td>
            </tr>
            {% endif %}
            {% if medidor.fecha_baja %}
            <tr>
                <th>Fecha de Baja:</th>
                <td>{{ medidor.fecha_baja|fecha_formato }}</td>
            </tr>
            {% endif %}
            {% if medidor.motivo_baja %}
            <tr>
                <th>Motivo de Baja:</th>
                <td>{{ medidor.motivo_baja }}</td>
            </tr>
            {% endif %}
        </table>

        <div style="margin-top: var(--spacing-lg);">
            {% if medidor.activo %}
            <button type="button" class="btn btn--warning" onclick="mostrarModalDesactivar()"><i class="fas fa-power-off"></i> Desactivar Medidor</button>
            {% else %}
            <button type="button" class="btn btn--success" onclick="mostrarModalReactivar()"><i class="fas fa-redo"></i> Reactivar Medidor</button>
            {% endif %}
        </div>
    </div>

    <div class="detail-section">
        <h3>Historial de Lecturas</h3>
        {% if lecturas %}
        <table class="data-table data-table--striped data-table--hover">
            <thead>
                <tr>
                    <th>Periodo</th>
                    <th>Lectura (m3)</th>
                    <th>Fecha</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for l in lecturas %}
                <tr>
                    <td>{{ l.mes|mes_nombre }} {{ l.a√±o }}</td>
                    <td>{{ l.lectura_m3 }}</td>
                    <td>{{ l.fecha_lectura|fecha_formato }}</td>
                    <td>
                        <a href="{{ url_for('lecturas.detalle', lectura_id=l.id) }}" class="action-btn" title="Ver detalle">
                            <i class="fas fa-eye"></i>
                        </a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <div class="empty-state">
            <div class="empty-state__icon"><i class="fas fa-tachometer-alt"></i></div>
            <h3 class="empty-state__title">Sin lecturas</h3>
            <p class="empty-state__description">No hay lecturas registradas para este medidor.</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Modal Desactivar -->
<div id="modalDesactivar" class="modal">
    <div class="modal__content">
        <div class="modal__header">
            <h3>Desactivar Medidor</h3>
            <button class="modal__close" onclick="cerrarModalDesactivar()">&times;</button>
        </div>
        <div class="modal__body">
            <form method="POST" action="{{ url_for('medidores.desactivar', medidor_id=medidor.id) }}">
                <div class="form-group">
                    <label for="fecha_baja">Fecha de Baja *</label>
                    <input type="date" id="fecha_baja" name="fecha_baja" required>
                </div>
                <div class="form-group">
                    <label for="motivo_baja">Motivo de Baja</label>
                    <textarea id="motivo_baja" name="motivo_baja" rows="3" placeholder="Ingrese el motivo de la desactivacion"></textarea>
                </div>
                <div class="modal__actions">
                    <button type="button" class="btn btn--secondary" onclick="cerrarModalDesactivar()">Cancelar</button>
                    <button type="submit" class="btn btn--warning">Confirmar Desactivacion</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Reactivar -->
<div id="modalReactivar" class="modal">
    <div class="modal__content">
        <div class="modal__header">
            <h3>Reactivar Medidor</h3>
            <button class="modal__close" onclick="cerrarModalReactivar()">&times;</button>
        </div>
        <div class="modal__body">
            <form method="POST" action="{{ url_for('medidores.reactivar', medidor_id=medidor.id) }}">
                <div class="form-group">
                    <label for="fecha_inicio_reactivar">Fecha de Inicio (opcional)</label>
                    <input type="date" id="fecha_inicio_reactivar" name="fecha_inicio">
                    <small class="form-help">Si no especifica una fecha, se mantendra la fecha de inicio original</small>
                </div>
                <div class="modal__actions">
                    <button type="button" class="btn btn--secondary" onclick="cerrarModalReactivar()">Cancelar</button>
                    <button type="submit" class="btn btn--success">Confirmar Reactivacion</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function mostrarModalDesactivar() {
    document.getElementById('modalDesactivar').classList.add('active');
}

function cerrarModalDesactivar() {
    document.getElementById('modalDesactivar').classList.remove('active');
}

function mostrarModalReactivar() {
    document.getElementById('modalReactivar').classList.add('active');
}

function cerrarModalReactivar() {
    document.getElementById('modalReactivar').classList.remove('active');
}

function eliminarMedidor() {
    ConfirmModal.show({
        title: 'Eliminar Medidor',
        message: 'Esta a punto de eliminar el medidor <strong>#{{ medidor.id }}</strong> del cliente <strong>{{ medidor.cliente_nombre }}</strong>. Esta accion no se puede deshacer.',
        icon: 'danger',
        confirmText: 'Eliminar',
        confirmClass: 'btn--danger'
    }).then(function(ok) {
        if (ok) {
            var form = document.createElement('form');
            form.method = 'POST';
            form.action = '{{ url_for("medidores.eliminar", medidor_id=medidor.id) }}';
            document.body.appendChild(form);
            form.submit();
        }
    });
}

// Close modals when clicking outside
document.querySelectorAll('.modal').forEach(function(modal) {
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            modal.classList.remove('active');
        }
    });
});
</script>
{% endblock %}
