{% extends "base.html" %}

{% block title %}Nueva Lectura Multiple - Sistema de Lecturas{% endblock %}

{% block content %}
<!-- HEADER -->
<div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6">
    <h1 class="text-2xl font-bold">Nueva Lectura Multiple</h1>
    <a href="{{ url_for('lecturas.listar') }}" class="btn btn-ghost">
        <i class="fas fa-arrow-left"></i>
        <span class="hidden sm:inline">Cancelar</span>
    </a>
</div>

<div class="card bg-base-100 shadow">
    <div class="card-body">
        <form method="POST" id="form-multiple">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div class="form-control">
                    <label class="label">
                        <span class="label-text font-medium">Medidor *</span>
                    </label>
                    <select name="medidor_id" id="medidor_id" required class="select select-bordered">
                        <option value="">Seleccione un medidor</option>
                        {% for m in medidores %}
                        <option value="{{ m.id }}">{{ m.cliente_nombre }} - Medidor #{{ m.id }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-control">
                    <label class="label">
                        <span class="label-text font-medium">Lectura (m3) *</span>
                    </label>
                    <input type="number" name="lectura_m3" id="lectura_m3" min="0" required
                           class="input input-bordered">
                    <label class="label">
                        <span class="label-text-alt text-base-content/70">Este valor se aplicara a todas las lecturas creadas.</span>
                    </label>
                </div>
            </div>

            <div class="card bg-base-200 mb-4">
                <div class="card-body">
                    <h3 class="card-title text-base">Rango de Periodos</h3>

                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text">Desde - Ano</span>
                            </label>
                            <select id="año_desde" required class="select select-bordered select-sm">
                                {% for a in años %}
                                <option value="{{ a }}">{{ a }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text">Desde - Mes</span>
                            </label>
                            <select id="mes_desde" required class="select select-bordered select-sm">
                                {% for m in range(1, 13) %}
                                <option value="{{ m }}">{{ m|mes_nombre }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text">Hasta - Ano</span>
                            </label>
                            <select id="año_hasta" required class="select select-bordered select-sm">
                                {% for a in años %}
                                <option value="{{ a }}">{{ a }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text">Hasta - Mes</span>
                            </label>
                            <select id="mes_hasta" required class="select select-bordered select-sm">
                                {% for m in range(1, 13) %}
                                <option value="{{ m }}">{{ m|mes_nombre }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    <button type="button" id="btn-calcular" class="btn btn-secondary btn-sm">
                        <i class="fas fa-calculator"></i> Calcular Periodos
                    </button>
                </div>
            </div>

            <div class="card bg-base-200 mb-4" id="fieldset-fechas" style="display: none;">
                <div class="card-body">
                    <h3 class="card-title text-base">Fechas de Lectura</h3>

                    <div id="fechas-status" class="alert alert-info mb-4"></div>

                    <div id="fechas-manuales" style="display: none;">
                        <div class="alert alert-warning mb-4">
                            <i class="fas fa-exclamation-triangle"></i>
                            <span>No se encontraron todas las fechas. Ingrese el dia para cada periodo faltante:</span>
                        </div>
                        <div id="inputs-dias" class="grid grid-cols-1 md:grid-cols-2 gap-2"></div>
                    </div>

                    <div id="tabla-periodos-container" class="overflow-x-auto">
                        <table class="table table-zebra" id="tabla-periodos">
                            <thead>
                                <tr>
                                    <th>Periodo</th>
                                    <th>Fecha de Lectura</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <input type="hidden" name="periodos_data" id="periodos_data">

            <div class="card-actions justify-end">
                <button type="submit" class="btn btn-primary" id="btn-submit" disabled>
                    <i class="fas fa-plus"></i> Crear Lecturas
                </button>
            </div>
        </form>
    </div>
</div>


<script>
const MESES = ['', 'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
               'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];

let periodosCalculados = [];
let fechasData = [];

document.getElementById('btn-calcular').addEventListener('click', calcularPeriodos);

function calcularPeriodos() {
    const anioDesde = parseInt(document.getElementById('año_desde').value);
    const mesDesde = parseInt(document.getElementById('mes_desde').value);
    const anioHasta = parseInt(document.getElementById('año_hasta').value);
    const mesHasta = parseInt(document.getElementById('mes_hasta').value);

    // Validar rango
    if (anioDesde > anioHasta || (anioDesde === anioHasta && mesDesde > mesHasta)) {
        Toast.warning('El periodo "Desde" debe ser anterior o igual al periodo "Hasta"');
        return;
    }

    // Generar lista de periodos
    periodosCalculados = [];
    let anio = anioDesde;
    let mes = mesDesde;

    while (anio < anioHasta || (anio === anioHasta && mes <= mesHasta)) {
        periodosCalculados.push({ anio, mes });
        mes++;
        if (mes > 12) {
            mes = 1;
            anio++;
        }
    }

    if (periodosCalculados.length === 0) {
        Toast.warning('No hay periodos en el rango seleccionado');
        return;
    }

    // Mostrar seccion de fechas
    document.getElementById('fieldset-fechas').style.display = 'block';
    document.getElementById('fechas-status').innerHTML = `Calculando fechas para ${periodosCalculados.length} periodos...`;

    // Consultar API para obtener fechas comunes
    fetch('{{ url_for("lecturas.api_fechas_comunes") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ periodos: periodosCalculados })
    })
    .then(response => response.json())
    .then(data => {
        fechasData = data.fechas;
        mostrarResultadoFechas(data);
    })
    .catch(error => {
        console.error('Error:', error);
        document.getElementById('fechas-status').innerHTML = 'Error al consultar fechas. Por favor ingrese las fechas manualmente.';
        mostrarInputsManuales(periodosCalculados.map(p => ({...p, dia: null, mes_lectura: p.mes === 12 ? 1 : p.mes + 1, anio_lectura: p.mes === 12 ? p.anio + 1 : p.anio})));
    });
}

function mostrarResultadoFechas(data) {
    const { fechas, todas_encontradas } = data;

    if (todas_encontradas) {
        document.getElementById('fechas-status').innerHTML =
            `Se encontraron las fechas mas comunes para los ${fechas.length} periodos.`;
        document.getElementById('fechas-manuales').style.display = 'none';
        actualizarTabla(fechas);
        habilitarSubmit();
    } else {
        const faltantes = fechas.filter(f => f.dia === null);
        document.getElementById('fechas-status').innerHTML =
            `Se encontraron fechas para ${fechas.length - faltantes.length} de ${fechas.length} periodos.`;
        document.getElementById('fechas-manuales').style.display = 'block';
        mostrarInputsManuales(faltantes);
        actualizarTabla(fechas);
    }
}

function mostrarInputsManuales(periodosFaltantes) {
    const container = document.getElementById('inputs-dias');
    container.innerHTML = '';

    periodosFaltantes.forEach(p => {
        const div = document.createElement('div');
        div.className = 'flex items-center gap-2 p-2 bg-base-100 rounded';
        div.innerHTML = `
            <label class="flex-1">${MESES[p.mes]} ${p.anio}:</label>
            <input type="number" min="1" max="31"
                   data-anio="${p.anio}" data-mes="${p.mes}"
                   data-mes-lectura="${p.mes_lectura}" data-anio-lectura="${p.anio_lectura}"
                   class="input input-bordered input-sm w-20 input-dia" placeholder="Dia">
            <span class="text-sm text-base-content/70">(Lectura en ${MESES[p.mes_lectura]} ${p.anio_lectura})</span>
        `;
        container.appendChild(div);
    });

    // Agregar listener para verificar cuando se completan todos
    container.querySelectorAll('.input-dia').forEach(input => {
        input.addEventListener('input', verificarDiasCompletos);
    });
}

function verificarDiasCompletos() {
    const inputs = document.querySelectorAll('.input-dia');
    let todosCompletos = true;

    inputs.forEach(input => {
        const valor = parseInt(input.value);
        if (!valor || valor < 1 || valor > 31) {
            todosCompletos = false;
        }
    });

    if (todosCompletos) {
        // Actualizar fechasData con los dias ingresados
        inputs.forEach(input => {
            const anio = parseInt(input.dataset.anio);
            const mes = parseInt(input.dataset.mes);
            const dia = parseInt(input.value);

            const idx = fechasData.findIndex(f => f.anio === anio && f.mes === mes);
            if (idx !== -1) {
                fechasData[idx].dia = dia;
            }
        });

        actualizarTabla(fechasData);
        habilitarSubmit();
    } else {
        document.getElementById('btn-submit').disabled = true;
    }
}

function actualizarTabla(fechas) {
    const tbody = document.querySelector('#tabla-periodos tbody');
    tbody.innerHTML = '';

    fechas.forEach(f => {
        const tr = document.createElement('tr');
        let fechaStr = '-';

        if (f.dia) {
            fechaStr = `${f.dia.toString().padStart(2, '0')}-${f.mes_lectura.toString().padStart(2, '0')}-${f.anio_lectura}`;
        }

        tr.innerHTML = `
            <td>${MESES[f.mes]} ${f.anio}</td>
            <td>${fechaStr}</td>
        `;
        tbody.appendChild(tr);
    });
}

function habilitarSubmit() {
    // Preparar datos para envio
    const periodosParaEnviar = fechasData.map(f => {
        // Formato fecha: YYYY-MM-DD
        const fechaLectura = `${f.anio_lectura}-${f.mes_lectura.toString().padStart(2, '0')}-${f.dia.toString().padStart(2, '0')}`;
        return {
            anio: f.anio,
            mes: f.mes,
            fecha_lectura: fechaLectura
        };
    });

    document.getElementById('periodos_data').value = JSON.stringify(periodosParaEnviar);
    document.getElementById('btn-submit').disabled = false;
}

// Validacion antes de enviar
document.getElementById('form-multiple').addEventListener('submit', function(e) {
    const medidor = document.getElementById('medidor_id').value;
    const lectura = document.getElementById('lectura_m3').value;
    const periodos = document.getElementById('periodos_data').value;

    if (!medidor || !lectura || !periodos) {
        e.preventDefault();
        Toast.warning('Complete todos los campos requeridos');
        return false;
    }

    const periodosData = JSON.parse(periodos);
    if (periodosData.length === 0) {
        e.preventDefault();
        Toast.warning('Debe calcular los periodos primero');
        return false;
    }

    e.preventDefault();
    var form = this;
    ConfirmModal.show({
        title: 'Crear Lecturas',
        message: `Se crearan ${periodosData.length} lecturas. ¿Continuar?`,
        icon: 'warning',
        confirmText: 'Crear Lecturas',
        confirmClass: 'btn-primary'
    }).then(function(ok) {
        if (ok) form.submit();
    });
    return false;
});
</script>
{% endblock %}
