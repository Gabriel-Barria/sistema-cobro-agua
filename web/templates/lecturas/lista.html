{% extends "base.html" %}

{% block title %}Lecturas - Sistema de Lecturas{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Lecturas</h1>
    <div>
        <a href="{{ url_for('lecturas.crear') }}" class="btn btn--primary">Nueva Lectura</a>
        <a href="{{ url_for('lecturas.crear_multiple') }}" class="btn btn--secondary">Lectura Multiple</a>
    </div>
</div>

<form method="GET" class="filter-bar" id="filterFormLecturas">
    <div class="filter-bar__fields">
        <div class="filter-bar__group">
            <select name="año">
                <option value="">Todos los años</option>
                {% for a in años %}
                <option value="{{ a }}" {% if a == año_sel %}selected{% endif %}>{{ a }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="filter-bar__group">
            <select name="mes">
                <option value="">Todos los meses</option>
                {% for m in range(1, 13) %}
                <option value="{{ m }}" {% if m == mes_sel %}selected{% endif %}>{{ m|mes_nombre }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="filter-bar__group">
            <select name="cliente_id" id="cliente_id">
                <option value="">Todos los clientes</option>
                {% for c in clientes %}
                {% if not incompletos or c.id in clientes_incompletos %}
                <option value="{{ c.id }}" {% if c.id == cliente_sel %}selected{% endif %}>{{ c.nombre }}</option>
                {% endif %}
                {% endfor %}
            </select>
        </div>

        <div class="filter-bar__group">
            <select name="medidor_id" id="medidor_id">
                <option value="">Todos los medidores</option>
                {% for m in medidores %}
                <option value="{{ m.id }}" {% if m.id == medidor_sel %}selected{% endif %}>{{ m.cliente_nombre }} - #{{ m.id }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="filter-bar__group filter-bar__group--checkbox">
            <input type="checkbox" name="incompletos" value="1" {% if incompletos %}checked{% endif %}>
            <label>Solo incompletos</label>
        </div>
    </div>
    <div class="filter-bar__actions">
        <button type="submit" class="btn btn--primary">Filtrar</button>
        <a href="{{ url_for('lecturas.listar') }}" class="btn btn--secondary">Limpiar</a>
    </div>
</form>

<p class="total-results">Total: {{ total }} lecturas</p>

{% if lecturas %}
<table class="data-table data-table--striped data-table--hover">
    <thead>
        <tr>
            <th class="sortable {% if orden_col == 'id' %}{{ orden_dir }}{% endif %}">
                <a href="{{ url_for('lecturas.listar', año=año_sel, mes=mes_sel, cliente_id=cliente_sel, medidor_id=medidor_sel, incompletos=1 if incompletos else None, orden='id', dir='desc' if orden_col == 'id' and orden_dir == 'asc' else 'asc') }}">ID</a>
            </th>
            <th class="sortable {% if orden_col == 'cliente' %}{{ orden_dir }}{% endif %}">
                <a href="{{ url_for('lecturas.listar', año=año_sel, mes=mes_sel, cliente_id=cliente_sel, medidor_id=medidor_sel, incompletos=1 if incompletos else None, orden='cliente', dir='desc' if orden_col == 'cliente' and orden_dir == 'asc' else 'asc') }}">Cliente</a>
            </th>
            <th class="sortable {% if orden_col == 'periodo' %}{{ orden_dir }}{% endif %}">
                <a href="{{ url_for('lecturas.listar', año=año_sel, mes=mes_sel, cliente_id=cliente_sel, medidor_id=medidor_sel, incompletos=1 if incompletos else None, orden='periodo', dir='desc' if orden_col == 'periodo' and orden_dir == 'asc' else 'asc') }}">Periodo</a>
            </th>
            <th class="sortable {% if orden_col == 'lectura_m3' %}{{ orden_dir }}{% endif %}">
                <a href="{{ url_for('lecturas.listar', año=año_sel, mes=mes_sel, cliente_id=cliente_sel, medidor_id=medidor_sel, incompletos=1 if incompletos else None, orden='lectura_m3', dir='desc' if orden_col == 'lectura_m3' and orden_dir == 'asc' else 'asc') }}">Lectura (m3)</a>
            </th>
            <th class="sortable {% if orden_col == 'fecha_lectura' %}{{ orden_dir }}{% endif %}">
                <a href="{{ url_for('lecturas.listar', año=año_sel, mes=mes_sel, cliente_id=cliente_sel, medidor_id=medidor_sel, incompletos=1 if incompletos else None, orden='fecha_lectura', dir='desc' if orden_col == 'fecha_lectura' and orden_dir == 'asc' else 'asc') }}">Fecha Lectura</a>
            </th>
            <th>Acciones</th>
        </tr>
    </thead>
    <tbody>
        {% for l in lecturas %}
        <tr>
            <td>{{ l.id }}</td>
            <td>{{ l.cliente_nombre }}</td>
            <td data-sort="{{ l.año * 100 + l.mes }}">{{ l.mes|mes_nombre }} {{ l.año }}</td>
            <td>{{ l.lectura_m3 }}</td>
            <td>{{ l.fecha_lectura|fecha_formato }}</td>
            <td>
                <div class="action-btn-group">
                    <a href="{{ url_for('lecturas.detalle', lectura_id=l.id) }}" class="action-btn" title="Ver detalle">
                        <i class="fas fa-eye"></i>
                    </a>
                    <a href="{{ url_for('lecturas.editar', lectura_id=l.id) }}" class="action-btn" title="Editar">
                        <i class="fas fa-edit"></i>
                    </a>
                </div>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

{% if total > per_page %}
<nav class="pagination">
    <span class="pagination__info">Pagina {{ page }} de {{ (total // per_page) + 1 }}</span>
    <div class="pagination__items">
        {% if page > 1 %}
        <a href="{{ url_for('lecturas.listar', page=page-1, año=año_sel, mes=mes_sel, cliente_id=cliente_sel, medidor_id=medidor_sel, incompletos=1 if incompletos else None, orden=orden_col, dir=orden_dir) }}" class="pagination__item" aria-label="Anterior">
            <i class="fas fa-chevron-left"></i>
        </a>
        {% endif %}

        {% if page * per_page < total %}
        <a href="{{ url_for('lecturas.listar', page=page+1, año=año_sel, mes=mes_sel, cliente_id=cliente_sel, medidor_id=medidor_sel, incompletos=1 if incompletos else None, orden=orden_col, dir=orden_dir) }}" class="pagination__item" aria-label="Siguiente">
            <i class="fas fa-chevron-right"></i>
        </a>
        {% endif %}
    </div>
</nav>
{% endif %}

{% else %}
<div class="empty-state">
    <div class="empty-state__icon"><i class="fas fa-tachometer-alt"></i></div>
    <h3 class="empty-state__title">No hay lecturas</h3>
    <p class="empty-state__description">No se encontraron lecturas con los filtros seleccionados.</p>
    <a href="{{ url_for('lecturas.listar') }}" class="btn btn--secondary">Limpiar Filtros</a>
</div>
{% endif %}

<script>
document.getElementById('cliente_id').addEventListener('change', function() {
    var clienteId = this.value;
    var medidorSelect = document.getElementById('medidor_id');
    medidorSelect.value = '';

    var url = '{{ url_for("lecturas.api_medidores") }}';
    if (clienteId) {
        url += '?cliente_id=' + clienteId;
    }

    fetch(url)
        .then(function(response) { return response.json(); })
        .then(function(medidores) {
            medidorSelect.innerHTML = '<option value="">Todos los medidores</option>';
            medidores.forEach(function(m) {
                var option = document.createElement('option');
                option.value = m.id;
                option.textContent = m.cliente_nombre + ' - #' + m.id;
                medidorSelect.appendChild(option);
            });
        });
});
</script>
{% endblock %}
