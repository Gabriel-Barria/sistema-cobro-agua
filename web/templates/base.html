<!DOCTYPE html>
<html lang="es" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Sistema de Cobro de Agua{% endblock %}</title>

    <!-- CSS Compilado (DaisyUI + Tailwind) -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dist/styles.css') }}">

    <!-- Font Awesome (iconos) -->
    <link rel="stylesheet" href="{{ url_for('static', filename='fonts/fontawesome/css/all.min.css') }}">

    <!-- Overrides custom -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/custom.css') }}">

    <!-- Theme initialization (antes del render) -->
    <script>
        (function() {
            const saved = localStorage.getItem('theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            const theme = saved || (prefersDark ? 'dark' : 'light');
            document.documentElement.setAttribute('data-theme', theme);
        })();
    </script>
</head>
<body class="min-h-screen bg-base-200">
    <!-- SVG Sprites (hidden) -->
    <svg xmlns="http://www.w3.org/2000/svg" class="hidden">
        <symbol id="icon-whatsapp" viewBox="0 0 16 16">
            <path d="M13.601 2.326A7.854 7.854 0 0 0 7.994 0C3.627 0 .068 3.558.064 7.926c0 1.399.366 2.76 1.057 3.965L0 16l4.204-1.102a7.933 7.933 0 0 0 3.79.965h.004c4.368 0 7.926-3.558 7.93-7.93A7.898 7.898 0 0 0 13.6 2.326zM7.994 14.521a6.573 6.573 0 0 1-3.356-.92l-.24-.144-2.494.654.666-2.433-.156-.251a6.56 6.56 0 0 1-1.007-3.505c0-3.626 2.957-6.584 6.591-6.584a6.56 6.56 0 0 1 4.66 1.931 6.557 6.557 0 0 1 1.928 4.66c-.004 3.639-2.961 6.592-6.592 6.592zm3.615-4.934c-.197-.099-1.17-.578-1.353-.646-.182-.065-.315-.099-.445.099-.133.197-.513.646-.627.775-.114.133-.232.148-.43.05-.197-.1-.836-.308-1.592-.985-.59-.525-.985-1.175-1.103-1.372-.114-.198-.011-.304.088-.403.087-.088.197-.232.296-.346.1-.114.133-.198.198-.33.065-.134.034-.248-.015-.347-.05-.099-.445-1.076-.612-1.47-.16-.389-.323-.335-.445-.34-.114-.007-.247-.007-.38-.007a.729.729 0 0 0-.529.247c-.182.198-.691.677-.691 1.654 0 .977.71 1.916.81 2.049.098.133 1.394 2.132 3.383 2.992.47.205.84.326 1.129.418.475.152.904.129 1.246.08.38-.058 1.171-.48 1.338-.943.164-.464.164-.86.114-.943-.049-.084-.182-.133-.38-.232z"/>
        </symbol>
    </svg>

    <div class="drawer lg:drawer-open">
        <input id="sidebar-toggle" type="checkbox" class="drawer-toggle" />

        <!-- Contenido principal -->
        <div class="drawer-content flex flex-col">
            <!-- Navbar mobile -->
            <div class="navbar bg-base-100 lg:hidden sticky top-0 z-30 shadow-sm">
                <div class="flex-none">
                    <label for="sidebar-toggle" class="btn btn-square btn-ghost">
                        <i class="fas fa-bars text-xl"></i>
                    </label>
                </div>
                <div class="flex-1">
                    <span class="font-bold text-lg">Sistema de Agua</span>
                </div>
                <div class="flex-none">
                    <button onclick="toggleTheme()" class="btn btn-square btn-ghost">
                        <i class="fas fa-moon dark:hidden"></i>
                        <i class="fas fa-sun hidden dark:inline"></i>
                    </button>
                </div>
            </div>

            <!-- Main content area -->
            <main class="flex-1 p-4 lg:p-6">
                <!-- Flash messages -->
                {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                        <div class="mb-4 space-y-2">
                        {% for category, message in messages %}
                            {% if category == 'success' %}
                            <div role="alert" class="alert alert-success">
                                <i class="fas fa-check-circle"></i>
                                <span>{{ message }}</span>
                            </div>
                            {% elif category == 'error' or category == 'danger' %}
                            <div role="alert" class="alert alert-error">
                                <i class="fas fa-exclamation-circle"></i>
                                <span>{{ message }}</span>
                            </div>
                            {% elif category == 'warning' %}
                            <div role="alert" class="alert alert-warning">
                                <i class="fas fa-exclamation-triangle"></i>
                                <span>{{ message }}</span>
                            </div>
                            {% else %}
                            <div role="alert" class="alert alert-info">
                                <i class="fas fa-info-circle"></i>
                                <span>{{ message }}</span>
                            </div>
                            {% endif %}
                        {% endfor %}
                        </div>
                    {% endif %}
                {% endwith %}

                {% block content %}{% endblock %}
            </main>

            <!-- Footer -->
            <footer class="footer footer-center p-4 bg-base-300 text-base-content">
                <aside>
                    <p>Sistema de Cobro de Agua</p>
                </aside>
            </footer>
        </div>

        <!-- Sidebar -->
        <div class="drawer-side z-40">
            <label for="sidebar-toggle" aria-label="close sidebar" class="drawer-overlay"></label>
            <aside class="bg-base-100 min-h-full w-64 flex flex-col">
                <!-- Header del sidebar -->
                <div class="p-4 border-b border-base-300">
                    <div class="flex items-center gap-3">
                        <i class="fas fa-tint text-primary text-2xl"></i>
                        <span class="font-bold text-lg">Sistema de Agua</span>
                    </div>
                </div>

                <!-- Navegacion principal -->
                <ul class="menu p-4 flex-1">
                    <!-- Dashboard -->
                    <li>
                        <a href="{{ url_for('index') }}" class="{% if request.endpoint == 'index' %}active{% endif %}">
                            <i class="fas fa-home w-5"></i>
                            Dashboard
                        </a>
                    </li>

                    <!-- Lecturas -->
                    <li>
                        <a href="{{ url_for('lecturas.listar') }}" class="{% if request.endpoint and 'lecturas' in request.endpoint %}active{% endif %}">
                            <i class="fas fa-clipboard-list w-5"></i>
                            Lecturas
                        </a>
                    </li>

                    <!-- Boletas -->
                    <li>
                        <details {% if (request.endpoint and 'boletas' in request.endpoint and request.endpoint not in ['boletas.pagos_lista', 'boletas.pago_detalle', 'boletas.registrar_pago_admin', 'boletas.saldos_lista', 'boletas.saldo_detalle']) or (request.endpoint and 'envio_masivo' in request.endpoint) %}open{% endif %}>
                            <summary>
                                <i class="fas fa-file-invoice-dollar w-5"></i>
                                Boletas
                            </summary>
                            <ul>
                                <li>
                                    <a href="{{ url_for('boletas.listar') }}" class="{% if request.endpoint in ['boletas.listar', 'boletas.detalle', 'boletas.crear', 'boletas.editar'] %}active{% endif %}">
                                        <i class="fas fa-list w-4"></i>
                                        Lista
                                    </a>
                                </li>
                                <li>
                                    <a href="{{ url_for('boletas.crear_masivo') }}" class="{% if request.endpoint == 'boletas.crear_masivo' %}active{% endif %}">
                                        <i class="fas fa-layer-group w-4"></i>
                                        Crear Masivo
                                    </a>
                                </li>
                                {% if session.get('rol') == 'administrador' %}
                                <li>
                                    <a href="{{ url_for('envio_masivo.index') }}" class="{% if request.endpoint and 'envio_masivo' in request.endpoint %}active{% endif %}">
                                        <svg class="w-4 h-4" fill="currentColor"><use href="#icon-whatsapp"/></svg>
                                        Envio WhatsApp
                                    </a>
                                </li>
                                {% endif %}
                                <li>
                                    <a href="{{ url_for('boletas.configuracion') }}" class="{% if request.endpoint == 'boletas.configuracion' %}active{% endif %}">
                                        <i class="fas fa-cog w-4"></i>
                                        Configuracion
                                    </a>
                                </li>
                            </ul>
                        </details>
                    </li>

                    {% if session.get('rol') == 'administrador' %}
                    <!-- Submenu Pagos (solo admin) -->
                    <li>
                        <details {% if request.endpoint in ['boletas.pagos_lista', 'boletas.pago_detalle', 'boletas.registrar_pago_admin', 'boletas.saldos_lista', 'boletas.saldo_detalle'] %}open{% endif %}>
                            <summary>
                                <i class="fas fa-money-bill-wave w-5"></i>
                                Pagos
                            </summary>
                            <ul>
                                <li>
                                    <a href="{{ url_for('boletas.pagos_lista') }}" class="{% if request.endpoint in ['boletas.pagos_lista', 'boletas.pago_detalle'] %}active{% endif %}">
                                        <i class="fas fa-list w-4"></i>
                                        Lista de Pagos
                                    </a>
                                </li>
                                <li>
                                    <a href="{{ url_for('boletas.registrar_pago_admin') }}" class="{% if request.endpoint == 'boletas.registrar_pago_admin' %}active{% endif %}">
                                        <i class="fas fa-plus-circle w-4"></i>
                                        Registrar Pago
                                    </a>
                                </li>
                                <li>
                                    <a href="{{ url_for('boletas.saldos_lista') }}" class="{% if request.endpoint in ['boletas.saldos_lista', 'boletas.saldo_detalle'] %}active{% endif %}">
                                        <i class="fas fa-wallet w-4"></i>
                                        Saldos
                                    </a>
                                </li>
                            </ul>
                        </details>
                    </li>
                    {% endif %}

                    <!-- Clientes -->
                    <li>
                        <a href="{{ url_for('clientes.listar') }}" class="{% if request.endpoint and 'clientes' in request.endpoint %}active{% endif %}">
                            <i class="fas fa-users w-5"></i>
                            Clientes
                        </a>
                    </li>

                    <!-- Medidores -->
                    <li>
                        <a href="{{ url_for('medidores.listar') }}" class="{% if request.endpoint and 'medidores' in request.endpoint %}active{% endif %}">
                            <i class="fas fa-gauge-high w-5"></i>
                            Medidores
                        </a>
                    </li>

                    {% if session.get('rol') == 'administrador' %}
                    <!-- Usuarios (solo admin) -->
                    <li>
                        <a href="{{ url_for('usuarios.lista') }}" class="{% if request.endpoint and 'usuarios' in request.endpoint %}active{% endif %}">
                            <i class="fas fa-user-shield w-5"></i>
                            Usuarios
                        </a>
                    </li>

                    <!-- Configuracion (solo admin) -->
                    <li>
                        <details {% if request.endpoint and ('configuracion' in request.endpoint or 'scheduler' in request.endpoint) %}open{% endif %}>
                            <summary>
                                <i class="fas fa-cogs w-5"></i>
                                Configuracion
                            </summary>
                            <ul>
                                <li>
                                    <a href="{{ url_for('configuracion.sistema') }}" class="{% if request.endpoint == 'configuracion.sistema' %}active{% endif %}">
                                        <i class="fas fa-sliders-h w-4"></i>
                                        Sistema
                                    </a>
                                </li>
                                <li>
                                    <a href="{{ url_for('configuracion.tarifas') }}" class="{% if request.endpoint == 'configuracion.tarifas' %}active{% endif %}">
                                        <i class="fas fa-dollar-sign w-4"></i>
                                        Tarifas
                                    </a>
                                </li>
                                <li>
                                    <a href="{{ url_for('scheduler.index') }}" class="{% if request.endpoint and 'scheduler' in request.endpoint %}active{% endif %}">
                                        <i class="fas fa-clock w-4"></i>
                                        Generacion Auto
                                    </a>
                                </li>
                            </ul>
                        </details>
                    </li>
                    {% endif %}

                    <div class="divider my-2"></div>

                    <!-- Interfaz Mobile -->
                    {% if session.get('rol') == 'administrador' %}
                    <li>
                        <a href="/mobile/lecturas">
                            <i class="fas fa-mobile-alt w-5"></i>
                            Vista Mobile
                        </a>
                    </li>
                    {% endif %}

                    <!-- Portal Publico -->
                    <li>
                        <a href="/portal/" target="_blank">
                            <i class="fas fa-globe w-5"></i>
                            Portal Publico
                            <i class="fas fa-external-link-alt text-xs opacity-50"></i>
                        </a>
                    </li>
                </ul>

                <!-- Footer del sidebar (Usuario) -->
                {% if session.get('usuario_id') %}
                <div class="border-t border-base-300 p-4">
                    <div class="flex items-center gap-3">
                        <div class="avatar placeholder">
                            <div class="bg-primary text-primary-content rounded-full w-10">
                                <span class="text-sm">{{ session.get('nombre_completo', 'U')[0] }}</span>
                            </div>
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="font-medium truncate">{{ session.get('nombre_completo', 'Usuario') }}</div>
                            <div class="text-xs opacity-60">{{ session.get('rol', '').title() }}</div>
                        </div>
                        <div class="flex gap-1">
                            <button onclick="toggleTheme()" class="btn btn-ghost btn-sm btn-square hidden lg:flex" title="Cambiar tema">
                                <i class="fas fa-moon dark:hidden"></i>
                                <i class="fas fa-sun hidden dark:inline"></i>
                            </button>
                            <a href="{{ url_for('auth.logout') }}" class="btn btn-ghost btn-sm btn-square text-error" title="Cerrar Sesion">
                                <i class="fas fa-sign-out-alt"></i>
                            </a>
                        </div>
                    </div>
                </div>
                {% endif %}
            </aside>
        </div>
    </div>

    <!-- Toast container -->
    <div id="toast-container" class="toast-container"></div>

    <script src="{{ url_for('static', filename='js/components.js') }}"></script>
    <script>
        // Theme toggle function
        function toggleTheme() {
            const html = document.documentElement;
            const current = html.getAttribute('data-theme');
            const next = current === 'dark' ? 'light' : 'dark';
            html.setAttribute('data-theme', next);
            localStorage.setItem('theme', next);
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Flash messages to Toast bridge
            var alerts = document.querySelectorAll('.alert');
            alerts.forEach(function(alert, index) {
                var text = alert.querySelector('span')?.textContent.trim();
                var type = 'info';
                if (alert.classList.contains('alert-success')) type = 'success';
                else if (alert.classList.contains('alert-error')) type = 'error';
                else if (alert.classList.contains('alert-warning')) type = 'warning';
                if (text && window.Toast) {
                    setTimeout(function() {
                        window.Toast.show(text, type);
                    }, index * 100);
                }
                alert.style.display = 'none';
            });

            // Table sorting
            function sortTable(th, updateUrl = true) {
                const table = th.closest('table');
                const tbody = table.querySelector('tbody');
                const rows = Array.from(tbody.querySelectorAll('tr'));
                const colIndex = Array.from(th.parentNode.children).indexOf(th);
                const isAsc = th.classList.contains('asc');
                const newOrder = isAsc ? 'desc' : 'asc';

                th.parentNode.querySelectorAll('th').forEach(h => {
                    h.classList.remove('asc', 'desc');
                });

                rows.sort(function(a, b) {
                    const aCell = a.children[colIndex];
                    const bCell = b.children[colIndex];
                    const aVal = aCell?.dataset.sort || aCell?.textContent.trim() || '';
                    const bVal = bCell?.dataset.sort || bCell?.textContent.trim() || '';
                    const aNum = parseFloat(aVal.replace(/[^\d.-]/g, ''));
                    const bNum = parseFloat(bVal.replace(/[^\d.-]/g, ''));

                    if (!isNaN(aNum) && !isNaN(bNum)) {
                        return isAsc ? bNum - aNum : aNum - bNum;
                    }
                    return isAsc ? bVal.localeCompare(aVal) : aVal.localeCompare(bVal);
                });

                th.classList.add(newOrder);
                rows.forEach(row => tbody.appendChild(row));

                if (updateUrl) {
                    const url = new URL(window.location);
                    url.searchParams.set('sort_by', colIndex);
                    url.searchParams.set('sort_order', newOrder);
                    window.history.replaceState({}, '', url);
                }
            }

            document.querySelectorAll('th.sortable').forEach(function(th) {
                th.addEventListener('click', function() {
                    sortTable(th, true);
                });
            });

            // Apply initial sort from URL
            const urlParams = new URLSearchParams(window.location.search);
            const sortBy = urlParams.get('sort_by');
            const sortOrder = urlParams.get('sort_order');

            if (sortBy !== null && sortOrder !== null) {
                const headers = document.querySelectorAll('th.sortable');
                const targetHeader = headers[parseInt(sortBy)];
                if (targetHeader) {
                    const oppositeOrder = sortOrder === 'asc' ? 'desc' : 'asc';
                    targetHeader.classList.add(oppositeOrder);
                    sortTable(targetHeader, false);
                }
            }

            // Expandable cards toggle
            document.querySelectorAll('[data-expandable]').forEach(function(card) {
                const summary = card.querySelector('[data-expand-trigger]');
                if (summary) {
                    summary.addEventListener('click', function(e) {
                        if (e.target.closest('a, button')) return;
                        const isExpanded = card.getAttribute('data-expanded') === 'true';
                        card.setAttribute('data-expanded', !isExpanded);
                    });
                }
            });
        });
    </script>
    {% block scripts %}{% endblock %}
</body>
</html>
