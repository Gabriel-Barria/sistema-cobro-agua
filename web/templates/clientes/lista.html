{% extends "base.html" %}

{% block title %}Clientes - Sistema de Cobro de Agua{% endblock %}

{% block content %}
<!-- HEADER -->
<div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6">
    <h1 class="text-2xl font-bold">Clientes</h1>
    <div class="flex gap-2">
        <a href="{{ url_for('clientes.crear') }}" class="btn btn-primary">
            <i class="fas fa-plus"></i>
            <span class="hidden sm:inline">Nuevo Cliente</span>
            <span class="sm:hidden">Nuevo</span>
        </a>
        <button type="button" onclick="modalExportar.showModal()" class="btn btn-success hidden sm:inline-flex">
            <i class="fas fa-file-excel"></i> Exportar Excel
        </button>
    </div>
</div>

<!-- STATS - colapsable -->
{% if stats %}
<div class="collapse collapse-stats collapse-arrow bg-base-100 shadow mb-4 hidden lg:block">
    <input type="checkbox" id="stats-toggle" />
    <div class="collapse-title font-medium flex items-center gap-2">
        <i class="fas fa-chart-bar text-primary"></i>
        Resumen
    </div>
    <div class="collapse-content">
        <div class="stats stats-vertical lg:stats-horizontal shadow w-full">
            <div class="stat">
                <div class="stat-title">Total Clientes</div>
                <div class="stat-value text-lg">{{ stats.total or 0 }}</div>
            </div>
            <div class="stat">
                <div class="stat-title">Con Medidor</div>
                <div class="stat-value text-lg text-success">{{ stats.con_medidor or 0 }}</div>
            </div>
            <div class="stat">
                <div class="stat-title">Sin Medidor</div>
                <div class="stat-value text-lg text-warning">{{ stats.sin_medidor or 0 }}</div>
            </div>
            <div class="stat">
                <div class="stat-title">Sin Telefono</div>
                <div class="stat-value text-lg text-error">{{ stats.sin_telefono or 0 }}</div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- FILTER CHIPS - solo mobile -->
<div class="flex items-center gap-2 overflow-x-auto pb-4 lg:hidden">
    <a href="{{ url_for('clientes.listar', busqueda=filtros.busqueda or '') }}"
       class="btn btn-sm {% if not filtros.con_medidores and not filtros.filtro_telefono %}btn-primary{% else %}btn-ghost{% endif %}">
        Todos
        {% if stats %}<span class="badge badge-sm ml-1">{{ stats.total or 0 }}</span>{% endif %}
    </a>
    <a href="{{ url_for('clientes.listar', busqueda=filtros.busqueda or '', con_medidores='si') }}"
       class="btn btn-sm {% if filtros.con_medidores == 'si' %}btn-primary{% else %}btn-ghost{% endif %}">
        Con medidor
        {% if stats %}<span class="badge badge-sm ml-1">{{ stats.con_medidor or 0 }}</span>{% endif %}
    </a>
    <a href="{{ url_for('clientes.listar', busqueda=filtros.busqueda or '', con_medidores='no') }}"
       class="btn btn-sm {% if filtros.con_medidores == 'no' %}btn-primary{% else %}btn-ghost{% endif %}">
        Sin medidor
        {% if stats %}<span class="badge badge-sm ml-1">{{ stats.sin_medidor or 0 }}</span>{% endif %}
    </a>
    <a href="{{ url_for('clientes.listar', busqueda=filtros.busqueda or '', filtro_telefono='sin') }}"
       class="btn btn-sm {% if filtros.filtro_telefono == 'sin' %}btn-primary{% else %}btn-ghost{% endif %}">
        Sin telefono
        {% if stats %}<span class="badge badge-sm ml-1">{{ stats.sin_telefono or 0 }}</span>{% endif %}
    </a>
    <button class="btn btn-sm btn-circle btn-ghost {% if filtros.busqueda %}btn-primary{% endif %}"
            onclick="modalFiltrosClientes.showModal()" title="Buscar">
        <i class="fas fa-search"></i>
    </button>
</div>

<!-- FILTER FORM - solo desktop -->
<form method="GET" class="card bg-base-100 shadow mb-4 hidden lg:block" id="filterFormClientes">
    <div class="card-body py-4">
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-4 items-end">
            <div class="form-control lg:col-span-2">
                <label class="label py-1"><span class="label-text">Buscar</span></label>
                <input type="text" name="busqueda" placeholder="Buscar por nombre, RUT, telefono, email..." value="{{ busqueda }}" class="input input-bordered input-sm">
            </div>
            <div class="form-control">
                <label class="label py-1"><span class="label-text">Medidores</span></label>
                <select name="con_medidores" class="select select-bordered select-sm">
                    <option value="">Todos los clientes</option>
                    <option value="si" {% if con_medidores == 'si' %}selected{% endif %}>Con medidores</option>
                    <option value="no" {% if con_medidores == 'no' %}selected{% endif %}>Sin medidores</option>
                </select>
            </div>
            <div class="form-control">
                <label class="label py-1"><span class="label-text">Telefono</span></label>
                <select name="filtro_telefono" class="select select-bordered select-sm">
                    <option value="">Todos (telefono)</option>
                    <option value="con" {% if filtro_telefono == 'con' %}selected{% endif %}>Con telefono</option>
                    <option value="sin" {% if filtro_telefono == 'sin' %}selected{% endif %}>Sin telefono</option>
                </select>
            </div>
        </div>
        <div class="flex gap-2 mt-4">
            <button type="submit" class="btn btn-primary btn-sm">Filtrar</button>
            {% if busqueda or con_medidores or filtro_telefono %}
            <a href="{{ url_for('clientes.listar') }}" class="btn btn-ghost btn-sm">Limpiar</a>
            {% endif %}
        </div>
    </div>
</form>

{% if clientes %}
<!-- CARDS - solo mobile -->
<div class="lg:hidden space-y-2" id="cardsContainer">
    {% for c in clientes %}
    <div class="collapse collapse-arrow bg-base-100 shadow">
        <input type="checkbox" class="peer" />
        <div class="collapse-title pr-12">
            <div class="flex justify-between items-center">
                <div class="min-w-0">
                    <div class="font-semibold truncate">{{ c.nombre }}</div>
                    <div class="text-sm text-base-content/70">{{ c.rut or 'Sin RUT' }}</div>
                </div>
                <div class="flex items-center gap-2 ml-4">
                    <span class="badge {% if c.num_medidores > 0 %}badge-success{% else %}badge-neutral{% endif %} badge-sm">
                        {{ c.num_medidores }} med.
                    </span>
                </div>
            </div>
        </div>
        <div class="collapse-content bg-base-200/50">
            <div class="grid grid-cols-2 gap-2 py-2 text-sm">
                <div class="text-base-content/70">
                    Telefono
                    <span class="block font-medium text-base-content">{{ c.telefono or '-' }}</span>
                </div>
                <div class="text-base-content/70">
                    Email
                    <span class="block font-medium text-base-content truncate">{{ c.email or '-' }}</span>
                </div>
            </div>
            <div class="flex flex-col gap-2 pt-2">
                <a href="{{ url_for('clientes.detalle', cliente_id=c.id) }}" class="btn btn-primary btn-sm">
                    <i class="fas fa-eye"></i> Ver Detalle
                </a>
                <button class="btn btn-ghost btn-sm" onclick="abrirModalEditar({{ c.id }}, '{{ c.nombre }}', '{{ c.nombre_completo or '' }}', '{{ c.rut or '' }}', '{{ c.telefono or '' }}', '{{ c.email or '' }}')">
                    <i class="fas fa-edit"></i> Editar
                </button>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<!-- TABLE - solo desktop -->
<div class="overflow-x-auto hidden lg:block">
    <table class="table table-zebra bg-base-100">
        <thead>
            <tr>
                <th class="sortable">ID</th>
                <th class="sortable">Nombre</th>
                <th class="sortable">Nombre Completo</th>
                <th class="sortable">RUT</th>
                <th class="sortable">Telefono</th>
                <th class="sortable">Email</th>
                <th class="sortable">Medidores</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody>
            {% for c in clientes %}
            <tr class="hover">
                <td>{{ c.id }}</td>
                <td>{{ c.nombre }}</td>
                <td>{{ c.nombre_completo or '-' }}</td>
                <td>{{ c.rut or '-' }}</td>
                <td>{{ c.telefono or '-' }}</td>
                <td>{{ c.email or '-' }}</td>
                <td>{{ c.num_medidores }}</td>
                <td>
                    <div class="flex gap-1">
                        <a href="{{ url_for('clientes.detalle', cliente_id=c.id) }}" class="btn btn-ghost btn-xs btn-square" title="Ver detalle">
                            <i class="fas fa-eye"></i>
                        </a>
                        <button onclick="abrirModalEditar({{ c.id }}, '{{ c.nombre }}', '{{ c.nombre_completo or '' }}', '{{ c.rut or '' }}', '{{ c.telefono or '' }}', '{{ c.email or '' }}')" class="btn btn-ghost btn-xs btn-square" title="Editar">
                            <i class="fas fa-edit"></i>
                        </button>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

{% else %}
<!-- Empty state -->
<div class="card bg-base-100 shadow">
    <div class="card-body items-center text-center py-12">
        <i class="fas fa-users text-5xl text-base-content/30 mb-4"></i>
        <h3 class="card-title">No hay clientes</h3>
        <p class="text-base-content/70 mb-4">No se encontraron clientes con los filtros seleccionados.</p>
        <div class="card-actions">
            {% if busqueda or con_medidores or filtro_telefono %}
            <a href="{{ url_for('clientes.listar') }}" class="btn btn-ghost">Limpiar Filtros</a>
            {% endif %}
            <a href="{{ url_for('clientes.crear') }}" class="btn btn-primary">+ Nuevo Cliente</a>
        </div>
    </div>
</div>
{% endif %}

<!-- Modal filtros/busqueda (mobile) -->
<dialog id="modalFiltrosClientes" class="modal modal-bottom sm:modal-middle">
    <div class="modal-box">
        <h3 class="font-bold text-lg mb-4">Buscar</h3>
        <form method="GET">
            {% if filtros.con_medidores %}
            <input type="hidden" name="con_medidores" value="{{ filtros.con_medidores }}">
            {% endif %}
            {% if filtros.filtro_telefono %}
            <input type="hidden" name="filtro_telefono" value="{{ filtros.filtro_telefono }}">
            {% endif %}

            <div class="form-control mb-4">
                <label class="label"><span class="label-text">Buscar</span></label>
                <input type="text" name="busqueda" placeholder="Nombre, RUT, telefono, email..." value="{{ filtros.busqueda or '' }}" class="input input-bordered">
            </div>

            <div class="modal-action">
                <a href="{{ url_for('clientes.listar') }}" class="btn btn-ghost">Limpiar</a>
                <button type="submit" class="btn btn-primary">Buscar</button>
            </div>
        </form>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>close</button>
    </form>
</dialog>

<!-- Modal para editar cliente -->
<dialog id="modalEditar" class="modal modal-bottom sm:modal-middle">
    <div class="modal-box">
        <h3 class="font-bold text-lg mb-4">Editar Cliente</h3>
        <form id="formEditar" method="POST">
            <input type="hidden" name="volver_a_lista" value="1">
            <input type="hidden" name="busqueda" value="{{ busqueda }}">
            <input type="hidden" name="con_medidores" value="{{ con_medidores }}">
            <input type="hidden" name="filtro_telefono" value="{{ filtro_telefono }}">

            <div class="form-control mb-3">
                <label class="label"><span class="label-text">Nombre *</span></label>
                <input type="text" name="nombre" id="edit_nombre" required class="input input-bordered">
                <label class="label"><span class="label-text-alt text-base-content/60">Nombre corto/identificador (se guarda en minusculas)</span></label>
            </div>

            <div class="form-control mb-3">
                <label class="label"><span class="label-text">Nombre Completo</span></label>
                <input type="text" name="nombre_completo" id="edit_nombre_completo" placeholder="Nombre legal completo" class="input input-bordered">
            </div>

            <div class="form-control mb-3">
                <label class="label"><span class="label-text">RUT</span></label>
                <input type="text" name="rut" id="edit_rut" placeholder="12.345.678-9" class="input input-bordered">
            </div>

            <div class="form-control mb-3">
                <label class="label"><span class="label-text">Telefono</span></label>
                <input type="tel" name="telefono" id="edit_telefono" placeholder="+56 9 1234 5678" class="input input-bordered">
            </div>

            <div class="form-control mb-4">
                <label class="label"><span class="label-text">Correo Electronico</span></label>
                <input type="email" name="email" id="edit_email" placeholder="cliente@ejemplo.com" class="input input-bordered">
            </div>

            <div class="modal-action">
                <button type="button" onclick="modalEditar.close()" class="btn btn-ghost">Cancelar</button>
                <button type="submit" class="btn btn-primary">Guardar Cambios</button>
            </div>
        </form>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>close</button>
    </form>
</dialog>

<!-- Modal para exportar -->
<dialog id="modalExportar" class="modal modal-bottom sm:modal-middle">
    <div class="modal-box">
        <h3 class="font-bold text-lg mb-4">Exportar a Excel</h3>
        <p class="text-base-content/70 mb-4">Selecciona las columnas que deseas exportar:</p>

        <div class="space-y-2">
            <label class="flex items-center gap-3 cursor-pointer">
                <input type="checkbox" id="col_id" checked class="checkbox checkbox-sm checkbox-primary">
                <span>ID</span>
            </label>
            <label class="flex items-center gap-3 cursor-pointer">
                <input type="checkbox" id="col_nombre" checked class="checkbox checkbox-sm checkbox-primary">
                <span>Nombre</span>
            </label>
            <label class="flex items-center gap-3 cursor-pointer">
                <input type="checkbox" id="col_nombre_completo" checked class="checkbox checkbox-sm checkbox-primary">
                <span>Nombre Completo</span>
            </label>
            <label class="flex items-center gap-3 cursor-pointer">
                <input type="checkbox" id="col_rut" checked class="checkbox checkbox-sm checkbox-primary">
                <span>RUT</span>
            </label>
            <label class="flex items-center gap-3 cursor-pointer">
                <input type="checkbox" id="col_telefono" checked class="checkbox checkbox-sm checkbox-primary">
                <span>Telefono</span>
            </label>
            <label class="flex items-center gap-3 cursor-pointer">
                <input type="checkbox" id="col_email" checked class="checkbox checkbox-sm checkbox-primary">
                <span>Email</span>
            </label>
            <label class="flex items-center gap-3 cursor-pointer">
                <input type="checkbox" id="col_medidores" checked class="checkbox checkbox-sm checkbox-primary">
                <span>Medidores</span>
            </label>
        </div>

        <div class="divider"></div>

        <label class="flex items-center gap-3 cursor-pointer">
            <input type="checkbox" id="seleccionar_todas" checked onchange="toggleTodasColumnas()" class="checkbox checkbox-sm">
            <span class="text-base-content/70">Seleccionar/Deseleccionar todas</span>
        </label>

        <div class="modal-action">
            <button type="button" onclick="modalExportar.close()" class="btn btn-ghost">Cancelar</button>
            <button type="button" onclick="exportarExcel()" class="btn btn-success">Exportar</button>
        </div>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>close</button>
    </form>
</dialog>

<script>
// === Edit modal ===
function abrirModalEditar(clienteId, nombre, nombreCompleto, rut, telefono, email) {
    document.getElementById('formEditar').action = '/clientes/' + clienteId + '/editar';
    document.getElementById('edit_nombre').value = nombre;
    document.getElementById('edit_nombre_completo').value = nombreCompleto;
    document.getElementById('edit_rut').value = rut;
    document.getElementById('edit_telefono').value = telefono;
    document.getElementById('edit_email').value = email;
    modalEditar.showModal();
}

// === Export functions ===
function toggleTodasColumnas() {
    var checked = document.getElementById('seleccionar_todas').checked;
    var columnas = ['col_id', 'col_nombre', 'col_nombre_completo', 'col_rut', 'col_telefono', 'col_email', 'col_medidores'];
    columnas.forEach(function(id) {
        document.getElementById(id).checked = checked;
    });
}

function exportarExcel() {
    var columnas = [];
    if (document.getElementById('col_id').checked) columnas.push('id');
    if (document.getElementById('col_nombre').checked) columnas.push('nombre');
    if (document.getElementById('col_nombre_completo').checked) columnas.push('nombre_completo');
    if (document.getElementById('col_rut').checked) columnas.push('rut');
    if (document.getElementById('col_telefono').checked) columnas.push('telefono');
    if (document.getElementById('col_email').checked) columnas.push('email');
    if (document.getElementById('col_medidores').checked) columnas.push('medidores');

    if (columnas.length === 0) {
        if (window.Toast) Toast.warning('Debes seleccionar al menos una columna');
        return;
    }

    var params = new URLSearchParams();
    var busqueda = '{{ busqueda or "" }}';
    var con_medidores = '{{ con_medidores or "" }}';
    var filtro_telefono = '{{ filtro_telefono or "" }}';

    if (busqueda) params.append('busqueda', busqueda);
    if (con_medidores) params.append('con_medidores', con_medidores);
    if (filtro_telefono) params.append('filtro_telefono', filtro_telefono);
    params.append('columnas', columnas.join(','));

    window.location.href = '/clientes/exportar?' + params.toString();
    modalExportar.close();
}

// Restore stats collapse state
(function() {
    var saved = localStorage.getItem('clientes-stats-open');
    if (saved === '1') {
        var toggle = document.getElementById('stats-toggle');
        if (toggle) toggle.checked = true;
    }
    document.getElementById('stats-toggle')?.addEventListener('change', function() {
        localStorage.setItem('clientes-stats-open', this.checked ? '1' : '0');
    });
})();
</script>
{% endblock %}
